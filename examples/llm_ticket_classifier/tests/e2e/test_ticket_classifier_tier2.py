"""
Tier 2 Playwright E2E Tests for ticket_classifier.

Auto-generated by Dazzle tier2_playwright generator.
These tests use the semantic DOM contract (data-dazzle-* attributes)
for reliable, stack-agnostic element selection.

Usage:
    pytest tests/e2e/test_tier2_generated.py -m tier2

With scenario seeding:
    Tests that specify a scenario will automatically seed data
    via the dev control plane before executing.
"""

from __future__ import annotations

import os

import pytest
from playwright.sync_api import Page, expect

# =============================================================================
# Configuration
# =============================================================================

BASE_URL = os.environ.get("DAZZLE_UI_URL", "http://localhost:3000")


@pytest.fixture
def base_url() -> str:
    """Base URL for the application under test."""
    return BASE_URL


# =============================================================================
# Helper: expect count greater than
# =============================================================================


def _expect_count_greater_than(locator, count: int, timeout: int = 5000):
    """Assert that a locator matches more than `count` elements."""
    import time

    start = time.time()
    while time.time() - start < timeout / 1000:
        if locator.count() > count:
            return
        time.sleep(0.1)
    raise AssertionError(f"Expected more than {count} elements, got {locator.count()}")


# Monkey-patch for convenience
expect.count_greater_than = lambda loc, n: _expect_count_greater_than(loc, n)


# =============================================================================
# Generated Tests
# =============================================================================


@pytest.mark.tier2
@pytest.mark.playwright
@pytest.mark.crud
@pytest.mark.list
@pytest.mark.ticket
def test_ticket_list_list(page: Page, base_url: str) -> None:
    """
    View list of Ticket records via Tickets

    Tags: tier2, playwright, crud, list, ticket
    """
    # Set scenario to 'active_tickets' via dev control plane
    page.locator('[data-dazzle-control="scenario-select"]').select_option("active_tickets")
    page.wait_for_load_state("networkidle")
    # Navigate to Tickets
    page.goto(f"{base_url}/ticket")
    page.wait_for_load_state("networkidle")
    # Assert Ticket table is visible
    expect(page.locator('[data-dazzle-table="Ticket"]')).to_be_visible()
    # Assert seeded data rows are visible
    expect(
        page.locator('[data-dazzle-table="Ticket"] [data-dazzle-row]')
    ).to_have_count_greater_than(0)


@pytest.mark.tier2
@pytest.mark.playwright
@pytest.mark.crud
@pytest.mark.view
@pytest.mark.ticket
def test_ticket_detail_view(page: Page, base_url: str) -> None:
    """
    View a single Ticket record via Ticket Detail

    Tags: tier2, playwright, crud, view, ticket
    """
    # Set scenario to 'active_tickets' via dev control plane
    page.locator('[data-dazzle-control="scenario-select"]').select_option("active_tickets")
    page.wait_for_load_state("networkidle")
    # Navigate to list view first
    page.goto(f"{base_url}/ticket")
    page.wait_for_load_state("networkidle")
    # Click first row to view details
    page.locator('[data-dazzle-table="Ticket"] [data-dazzle-row]:first-child').click()
    page.wait_for_load_state("networkidle")
    # Assert Ticket Detail view is visible
    expect(page.locator('[data-dazzle-view="ticket_detail"]')).to_be_visible()


@pytest.mark.tier2
@pytest.mark.playwright
@pytest.mark.crud
@pytest.mark.list
@pytest.mark.ticketclassification
def test_classification_list_list(page: Page, base_url: str) -> None:
    """
    View list of TicketClassification records via Classifications

    Tags: tier2, playwright, crud, list, ticketclassification
    """
    # Set scenario to 'active_tickets' via dev control plane
    page.locator('[data-dazzle-control="scenario-select"]').select_option("active_tickets")
    page.wait_for_load_state("networkidle")
    # Navigate to Classifications
    page.goto(f"{base_url}/ticketclassification")
    page.wait_for_load_state("networkidle")
    # Assert TicketClassification table is visible
    expect(page.locator('[data-dazzle-table="TicketClassification"]')).to_be_visible()
    # Assert seeded data rows are visible
    expect(
        page.locator('[data-dazzle-table="TicketClassification"] [data-dazzle-row]')
    ).to_have_count_greater_than(0)


@pytest.mark.tier2
@pytest.mark.high_priority
@pytest.mark.playwright
@pytest.mark.crud
@pytest.mark.delete
@pytest.mark.ticket
def test_ticket_delete(page: Page, base_url: str) -> None:
    """
    Delete a Ticket record

    Tags: tier2, playwright, crud, delete, ticket
    """
    # Set scenario to 'active_tickets' via dev control plane
    page.locator('[data-dazzle-control="scenario-select"]').select_option("active_tickets")
    page.wait_for_load_state("networkidle")
    # Navigate to list view
    page.goto(f"{base_url}/ticket")
    page.wait_for_load_state("networkidle")
    # Count rows before delete
    initial_count = page.locator('[data-dazzle-table="Ticket"] [data-dazzle-row]').count()
    # Click delete on first row
    page.locator(
        '[data-dazzle-table="Ticket"] [data-dazzle-row]:first-child [data-dazzle-action="Ticket.delete"], [data-dazzle-table="Ticket"] [data-dazzle-row]:first-child [data-dazzle-action-role="destructive"]'
    ).first.click()
    page.wait_for_load_state("networkidle")
    # Confirm delete if dialog appears
    if page.locator("[data-dazzle-dialog]").is_visible():
        page.locator('[data-dazzle-dialog] [data-dazzle-action-role="destructive"]').click()
        page.wait_for_load_state("networkidle")
    # Assert row count decreased by 1
    expect(page.locator('[data-dazzle-table="Ticket"] [data-dazzle-row]')).to_have_count(
        initial_count - 1
    )


@pytest.mark.tier2
@pytest.mark.high_priority
@pytest.mark.playwright
@pytest.mark.crud
@pytest.mark.delete
@pytest.mark.ticketclassification
def test_ticketclassification_delete(page: Page, base_url: str) -> None:
    """
    Delete a TicketClassification record

    Tags: tier2, playwright, crud, delete, ticketclassification
    """
    # Set scenario to 'active_tickets' via dev control plane
    page.locator('[data-dazzle-control="scenario-select"]').select_option("active_tickets")
    page.wait_for_load_state("networkidle")
    # Navigate to list view
    page.goto(f"{base_url}/ticketclassification")
    page.wait_for_load_state("networkidle")
    # Count rows before delete
    initial_count = page.locator(
        '[data-dazzle-table="TicketClassification"] [data-dazzle-row]'
    ).count()
    # Click delete on first row
    page.locator(
        '[data-dazzle-table="TicketClassification"] [data-dazzle-row]:first-child [data-dazzle-action="TicketClassification.delete"], [data-dazzle-table="TicketClassification"] [data-dazzle-row]:first-child [data-dazzle-action-role="destructive"]'
    ).first.click()
    page.wait_for_load_state("networkidle")
    # Confirm delete if dialog appears
    if page.locator("[data-dazzle-dialog]").is_visible():
        page.locator('[data-dazzle-dialog] [data-dazzle-action-role="destructive"]').click()
        page.wait_for_load_state("networkidle")
    # Assert row count decreased by 1
    expect(
        page.locator('[data-dazzle-table="TicketClassification"] [data-dazzle-row]')
    ).to_have_count(initial_count - 1)
