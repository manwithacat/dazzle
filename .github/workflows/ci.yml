name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  python-tests:
    name: Python Tests (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "${{ matrix.python-version }}"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,mobile]"
        # Install optional LSP dependencies
        pip install pygls || true

    - name: Run tests with pytest
      run: |
        pytest -v --cov=src/dazzle --cov-report=xml --cov-report=term-missing -m "not e2e"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        flags: unittests
        fail_ci_if_error: false

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,mobile]"

    - name: Run JWT security tests
      run: |
        pytest tests/unit/test_jwt_security.py -v --tb=short

    - name: Run JWT fuzzing tests
      run: |
        pytest tests/unit/test_jwt_fuzzing.py -v --tb=short

    - name: Run bandit security scanner
      run: |
        pip install bandit[toml]
        bandit -c pyproject.toml -r src/dazzle_back/runtime/ --severity-level medium

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp]"
        # Install optional LSP dependencies
        pip install pygls || true

    - name: Run ruff linter
      run: |
        ruff check src/ tests/

    - name: Run ruff formatter check
      run: |
        ruff format --check src/ tests/

    - name: Run bandit security check
      run: |
        pip install bandit[toml]
        bandit -c pyproject.toml -r src/ --severity-level medium

    - name: Check DSL files (strict mode)
      run: |
        for example in simple_task contact_manager ops_dashboard support_tickets fieldtest_hub; do
          echo "Checking DSL for $example..."
          cd examples/$example
          python -m dazzle validate --strict || echo "Note: Some warnings in $example"
          cd ../..
        done

    - name: Generate and validate AsyncAPI specs
      run: |
        # Install AsyncAPI CLI for validation
        npm install -g @asyncapi/cli

        # Generate and validate AsyncAPI for each example
        for example in simple_task contact_manager ops_dashboard support_tickets fieldtest_hub; do
          echo "Generating AsyncAPI for $example..."
          cd examples/$example
          python -m dazzle specs asyncapi -f json -o asyncapi.json

          # Validate the generated AsyncAPI spec
          if [ -f asyncapi.json ]; then
            echo "Validating AsyncAPI spec for $example..."
            asyncapi validate asyncapi.json || echo "Warning: AsyncAPI validation issues in $example"
            rm asyncapi.json
          fi
          cd ../..
        done

  type-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp]"
        # Install optional LSP dependencies
        pip install pygls || true

    - name: Run mypy
      run: |
        # Check core modules (parser, IR, CLI, MCP) - eject module excluded for now
        mypy src/dazzle/core src/dazzle/cli src/dazzle/mcp --ignore-missing-imports --exclude 'eject'
        # Check backend runtime
        mypy src/dazzle_back/ --ignore-missing-imports

  integration:
    runs-on: ubuntu-latest
    needs: [python-tests, lint, security-tests]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,mobile]"
        # Install optional LSP dependencies
        pip install pygls || true

    - name: Run integration tests
      run: |
        pytest tests/integration/ -v --maxfail=1 -m "not e2e"

    - name: Test CLI commands
      run: |
        python -m dazzle --help
        python -m dazzle --version

  runtime-e2e:
    runs-on: ubuntu-latest
    needs: [python-tests, lint, security-tests]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,mobile]"

    - name: Validate example projects
      run: |
        for example in simple_task contact_manager; do
          echo "Validating $example..."
          cd examples/$example
          python -m dazzle validate
          cd ../..
        done

    - name: Run E2E tests (serve)
      run: |
        pytest tests/e2e/test_serve.py -v --timeout=120
      timeout-minutes: 5

    - name: Run E2E tests (integration)
      run: |
        pytest tests/integration/test_runtime_e2e.py -v -m e2e --timeout=120
      timeout-minutes: 10

  postgres-tests:
    name: PostgreSQL Tests
    runs-on: ubuntu-latest
    needs: [lint]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: dazzle
          POSTGRES_PASSWORD: dazzle_test
          POSTGRES_DB: dazzle_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,mobile,postgres]"
        pip install pygls || true

    - name: Run tests with PostgreSQL
      env:
        DATABASE_URL: postgresql://dazzle:dazzle_test@localhost:5432/dazzle_test
      run: |
        pytest -v --cov=src/dazzle --cov-report=term-missing -m "not e2e" -x

  # Matrix-based E2E testing for example projects
  # TODO: Remove continue-on-error once HTMX templates emit data-dazzle-* attributes
  # Blocked on: DOM contract alignment between test generator and HTMX templates
  example-e2e:
    name: E2E - ${{ matrix.example }}
    runs-on: ubuntu-latest
    continue-on-error: true  # Advisory until DOM contract is aligned
    needs: [python-tests, lint]
    strategy:
      fail-fast: false  # Run all examples even if one fails
      matrix:
        example:
          - simple_task
          - contact_manager
        # Add more examples as they become stable:
        # - uptime_monitor
        # - inventory_scanner
        # - ops_dashboard
        include:
          - example: simple_task
            priority: high  # P0 - blocks PRs
          - example: contact_manager
            priority: high  # P0 - blocks PRs

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp]"
        pip install playwright

    - name: Install Playwright browsers
      run: |
        playwright install chromium --with-deps

    - name: Validate project
      run: |
        cd examples/${{ matrix.example }}
        python -m dazzle validate

    - name: Cleanup stale Docker containers
      run: |
        docker stop $(docker ps -q --filter "name=dazzle-") 2>/dev/null || true
        docker rm $(docker ps -aq --filter "name=dazzle-") 2>/dev/null || true

    - name: Start Dazzle server in test mode
      run: |
        cd examples/${{ matrix.example }}
        python -m dazzle serve --test-mode --local --port 3000 --api-port 8000 > /tmp/dazzle-server.log 2>&1 &
        SERVER_PID=$!
        echo "Server PID: $SERVER_PID"
        for i in {1..45}; do
          if curl -s http://localhost:8000/health > /dev/null 2>&1; then
            echo "Server is ready"
            break
          fi
          if ! kill -0 $SERVER_PID 2>/dev/null; then
            echo "Server process died. Logs:"
            cat /tmp/dazzle-server.log
            exit 1
          fi
          echo "Waiting for server... ($i/45)"
          sleep 2
        done
        curl -f http://localhost:8000/health || { echo "Health check failed. Logs:"; cat /tmp/dazzle-server.log; exit 1; }
      timeout-minutes: 3

    - name: Run E2E tests
      run: |
        cd examples/${{ matrix.example }}
        python -m dazzle test run --no-auto-server --priority ${{ matrix.priority }} --verbose
      timeout-minutes: 5

    - name: Run viewport assertions
      run: |
        cd examples/${{ matrix.example }}
        python -c "
        from pathlib import Path
        from dazzle.core.loader import load_and_link
        from dazzle.testing.viewport import derive_patterns_from_appspec
        from dazzle.testing.viewport_runner import ViewportRunner, ViewportRunOptions
        import sys
        appspec = load_and_link(Path('.'))
        patterns = derive_patterns_from_appspec(appspec)
        if not patterns:
            sys.exit(0)
        result = ViewportRunner(Path('.')).run(patterns, ViewportRunOptions(base_url='http://localhost:3000'))
        print(result.to_markdown())
        if result.total_failed > 0:
            print(f'::warning::Viewport: {result.total_failed} failures')
        "
      timeout-minutes: 2
      continue-on-error: true

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: e2e-failure-${{ matrix.example }}
        path: |
          examples/${{ matrix.example }}/testspec.json
          examples/${{ matrix.example }}/test-results/
        retention-days: 7

    - name: Cleanup
      if: always()
      run: |
        pkill -f "dazzle serve" || true
        # Stop any Docker containers that may have been started
        docker stop $(docker ps -q --filter "name=dazzle-") 2>/dev/null || true
        docker rm $(docker ps -aq --filter "name=dazzle-") 2>/dev/null || true

  # Additional examples (P1/P2 priority - warning only)
  example-e2e-extended:
    name: E2E Extended - ${{ matrix.example }}
    runs-on: ubuntu-latest
    needs: [python-tests, lint]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'  # Only on main branch
    strategy:
      fail-fast: false
      matrix:
        example:
          - ops_dashboard
          - support_tickets
          - fieldtest_hub
        include:
          - example: ops_dashboard
            priority: medium
          - example: support_tickets
            priority: medium
          - example: fieldtest_hub
            priority: low

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp]"
        pip install playwright

    - name: Install Playwright browsers
      run: |
        playwright install chromium --with-deps

    - name: Validate and test
      run: |
        cd examples/${{ matrix.example }}
        # P1/P2 examples - validation failures are informational only
        python -m dazzle validate || echo "Note: Validation issues found (P1/P2 example)"

    - name: Cleanup stale Docker containers
      run: |
        # Remove any stale dazzle containers from previous runs
        docker stop $(docker ps -q --filter "name=dazzle-") 2>/dev/null || true
        docker rm $(docker ps -aq --filter "name=dazzle-") 2>/dev/null || true
        docker network prune -f 2>/dev/null || true

    - name: Start server and run tests
      run: |
        cd examples/${{ matrix.example }}
        python -m dazzle serve --test-mode --local &
        sleep 5
        # P1/P2 examples - test failures are informational only
        # Use --no-auto-server since we started the server above
        python -m dazzle test run --no-auto-server --priority ${{ matrix.priority }} --verbose || echo "Note: Some tests did not pass (P1/P2 example - expected during development)"
      timeout-minutes: 5

    - name: Cleanup
      if: always()
      run: |
        # Kill local server process
        pkill -f "dazzle serve" || true
        # Stop any Docker containers
        docker stop $(docker ps -q --filter "name=dazzle-") 2>/dev/null || true
        docker rm $(docker ps -aq --filter "name=dazzle-") 2>/dev/null || true

  e2e-postgres:
    name: E2E - simple_task (PostgreSQL)
    runs-on: ubuntu-latest
    continue-on-error: true  # Advisory until fully proven
    needs: [postgres-tests]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: dazzle
          POSTGRES_PASSWORD: dazzle_test
          POSTGRES_DB: dazzle_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,postgres]"
        pip install playwright

    - name: Install Playwright browsers
      run: |
        playwright install chromium --with-deps

    - name: Validate project
      run: |
        cd examples/simple_task
        python -m dazzle validate

    - name: Start Dazzle server with PostgreSQL
      env:
        DATABASE_URL: postgresql://dazzle:dazzle_test@localhost:5432/dazzle_test
      run: |
        cd examples/simple_task
        python -m dazzle serve --test-mode --local --port 3000 --api-port 8000 > /tmp/dazzle-server.log 2>&1 &
        SERVER_PID=$!
        echo "Server PID: $SERVER_PID"
        for i in {1..45}; do
          if curl -s http://localhost:8000/health > /dev/null 2>&1; then
            echo "Server is ready"
            break
          fi
          if ! kill -0 $SERVER_PID 2>/dev/null; then
            echo "Server process died. Logs:"
            cat /tmp/dazzle-server.log
            exit 1
          fi
          echo "Waiting for server... ($i/45)"
          sleep 2
        done
        curl -f http://localhost:8000/health || { echo "Health check failed. Logs:"; cat /tmp/dazzle-server.log; exit 1; }
      timeout-minutes: 3

    - name: Run E2E tests
      run: |
        cd examples/simple_task
        python -m dazzle test run --no-auto-server --priority high --verbose
      timeout-minutes: 5

    - name: Run DSL tests against PostgreSQL
      run: |
        cd examples/simple_task
        python -m dazzle test run --no-auto-server --verbose || echo "Note: Some DSL tests may not pass yet"
      timeout-minutes: 5
      continue-on-error: true

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: e2e-postgres-failure
        path: |
          examples/simple_task/testspec.json
          examples/simple_task/test-results/
          /tmp/dazzle-server.log
        retention-days: 7

    - name: Cleanup
      if: always()
      run: |
        pkill -f "dazzle serve" || true

  # Homebrew formula validation - ensures formula is syntactically correct
  # and version numbers are consistent across all files
  homebrew-validation:
    name: Homebrew Formula Validation
    runs-on: macos-14  # Need macOS for brew commands

    steps:
    - uses: actions/checkout@v6

    - name: Extract expected version
      id: version
      run: |
        # Get version from pyproject.toml (source of truth)
        VERSION=$(grep '^version = ' pyproject.toml | head -1 | cut -d'"' -f2)
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Expected version: ${VERSION}"

    - name: Validate formula syntax
      run: |
        # Check Ruby syntax
        ruby -c homebrew/dazzle.rb || { echo "ERROR: Formula has Ruby syntax errors"; exit 1; }
        echo "✓ Formula syntax is valid"

    - name: Check version consistency
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"

        # Check formula version (skip PLACEHOLDER check - handled at release time)
        FORMULA_VERSION=$(grep 'version "' homebrew/dazzle.rb | head -1 | cut -d'"' -f2)

        # Formula may have PLACEHOLDER_VERSION before release
        if [[ "${FORMULA_VERSION}" == "PLACEHOLDER_VERSION" ]]; then
          echo "Note: Formula has placeholder version (will be updated at release time)"
        elif [[ "${FORMULA_VERSION}" != "${VERSION}" ]]; then
          echo "WARNING: Formula version (${FORMULA_VERSION}) differs from pyproject.toml (${VERSION})"
          echo "This may be expected if preparing a release"
        else
          echo "✓ Formula version matches pyproject.toml: ${VERSION}"
        fi

        # Check CLI version
        CLI_VERSION=$(grep '"version":' cli/package.json | cut -d'"' -f4)
        if [[ "${CLI_VERSION}" != "${VERSION}" ]]; then
          echo "ERROR: CLI version (${CLI_VERSION}) doesn't match pyproject.toml (${VERSION})"
          exit 1
        fi
        echo "✓ CLI version matches: ${CLI_VERSION}"

    - name: Validate formula structure
      run: |
        # Ensure required sections exist
        echo "Checking required formula sections..."

        grep -q 'class Dazzle < Formula' homebrew/dazzle.rb || { echo "ERROR: Missing Dazzle class"; exit 1; }
        grep -q 'desc "' homebrew/dazzle.rb || { echo "ERROR: Missing description"; exit 1; }
        grep -q 'homepage "' homebrew/dazzle.rb || { echo "ERROR: Missing homepage"; exit 1; }
        grep -q 'def install' homebrew/dazzle.rb || { echo "ERROR: Missing install method"; exit 1; }
        grep -q 'test do' homebrew/dazzle.rb || { echo "ERROR: Missing test block"; exit 1; }
        grep -q 'resource "cli-binary"' homebrew/dazzle.rb || { echo "ERROR: Missing cli-binary resource"; exit 1; }
        grep -q 'resource "pydantic-core"' homebrew/dazzle.rb || { echo "ERROR: Missing pydantic-core resource"; exit 1; }

        echo "✓ All required formula sections present"

    - name: Check for common issues
      run: |
        # Check for unexpanded shell variables (shouldn't happen in template)
        if grep -E '\$\{[A-Z_]+\}' homebrew/dazzle.rb | grep -v 'PLACEHOLDER'; then
          echo "WARNING: Found unexpanded shell variables"
        fi

        # Check for hardcoded paths that should be variables
        if grep -E '/usr/local|/opt/homebrew' homebrew/dazzle.rb; then
          echo "WARNING: Found hardcoded paths - use Homebrew variables instead"
        fi

        # Ensure Python version dependency is reasonable
        PYTHON_DEP=$(grep 'depends_on "python@' homebrew/dazzle.rb | head -1)
        echo "Python dependency: ${PYTHON_DEP}"

        echo "✓ Formula passed common issue checks"

    - name: Validate PyPI wheel URLs
      run: |
        echo "Checking PyPI wheel URLs in formula..."

        # Extract and validate all PyPI URLs (skip PLACEHOLDERs)
        URLS=$(grep -oE 'https://files.pythonhosted.org/[^"]+\.whl' homebrew/dazzle.rb || true)

        if [ -z "$URLS" ]; then
          echo "Note: No PyPI wheel URLs found (may be using placeholders)"
          exit 0
        fi

        FAILED=0
        for url in $URLS; do
          echo -n "  Checking $url... "
          if curl -sIf "$url" > /dev/null 2>&1; then
            echo "✓"
          else
            echo "✗ INVALID"
            FAILED=1
          fi
        done

        if [ $FAILED -eq 1 ]; then
          echo "ERROR: One or more PyPI wheel URLs are invalid!"
          exit 1
        fi

        echo "✓ All PyPI wheel URLs are valid"
