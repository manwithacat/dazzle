name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  python-tests:
    name: Python Tests (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "${{ matrix.python-version }}"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,mobile,postgres]"
        # Install optional LSP dependencies
        pip install pygls || true

    - name: Run tests with pytest
      run: |
        pytest -v --cov=src/dazzle --cov-report=xml --cov-report=term-missing -m "not e2e"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        flags: unittests
        fail_ci_if_error: false

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,mobile,postgres]"

    - name: Run JWT security tests
      run: |
        pytest tests/unit/test_jwt_security.py -v --tb=short

    - name: Run JWT fuzzing tests
      run: |
        pytest tests/unit/test_jwt_fuzzing.py -v --tb=short

    - name: Run bandit security scanner
      run: |
        pip install bandit[toml]
        bandit -c pyproject.toml -r src/dazzle_back/runtime/ --severity-level medium

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,postgres]"
        # Install optional LSP dependencies
        pip install pygls || true

    - name: Run ruff linter
      run: |
        ruff check src/ tests/

    - name: Run ruff formatter check
      run: |
        ruff format --check src/ tests/

    - name: Run bandit security check
      run: |
        pip install bandit[toml]
        bandit -c pyproject.toml -r src/ --severity-level medium

    - name: Check DSL files (strict mode)
      run: |
        for dir in examples/*/; do
          if [ -f "${dir}dazzle.toml" ]; then
            example=$(basename "$dir")
            echo "Checking DSL for $example..."
            cd "$dir"
            python -m dazzle validate --strict || echo "Note: Some warnings in $example"
            cd "$GITHUB_WORKSPACE"
          fi
        done

    - name: Generate and validate AsyncAPI specs
      run: |
        # Install AsyncAPI CLI for validation
        npm install -g @asyncapi/cli

        # Generate and validate AsyncAPI for each example
        for dir in examples/*/; do
          if [ -f "${dir}dazzle.toml" ]; then
            example=$(basename "$dir")
            echo "Generating AsyncAPI for $example..."
            cd "$dir"
            python -m dazzle specs asyncapi -f json -o asyncapi.json || echo "Note: No AsyncAPI output for $example"

            # Validate the generated AsyncAPI spec
            if [ -f asyncapi.json ]; then
              echo "Validating AsyncAPI spec for $example..."
              asyncapi validate asyncapi.json || echo "Warning: AsyncAPI validation issues in $example"
              rm asyncapi.json
            fi
            cd "$GITHUB_WORKSPACE"
          fi
        done

  type-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,postgres]"
        # Install optional dependencies for type checking
        pip install pygls bleach || true

    - name: Run mypy
      run: |
        # Check core modules (parser, IR, CLI, MCP) - eject module excluded for now
        mypy src/dazzle/core src/dazzle/cli src/dazzle/mcp --ignore-missing-imports --exclude 'eject'
        # Check backend runtime
        mypy src/dazzle_back/ --ignore-missing-imports

  integration:
    runs-on: ubuntu-latest
    needs: [python-tests, lint, security-tests]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,mobile]"
        # Install optional LSP dependencies
        pip install pygls || true

    - name: Run integration tests
      run: |
        pytest tests/integration/ -v --maxfail=1 -m "not e2e"

    - name: Test CLI commands
      run: |
        python -m dazzle --help
        python -m dazzle --version

  # Smoke tests: validate all examples parse + lint, run moved test_serve_validation.py
  e2e-smoke:
    name: E2E Smoke
    runs-on: ubuntu-latest
    needs: [python-tests, lint]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,mobile]"

    - name: Validate all example projects
      run: |
        for dir in examples/*/; do
          if [ -f "${dir}dazzle.toml" ]; then
            example=$(basename "$dir")
            echo "Validating $example..."
            cd "$dir"
            python -m dazzle validate
            cd "$GITHUB_WORKSPACE"
          fi
        done

    - name: Lint all example DSL files
      run: |
        for dir in examples/*/; do
          if [ -f "${dir}dazzle.toml" ]; then
            example=$(basename "$dir")
            echo "Linting $example..."
            cd "$dir"
            python -m dazzle lint || echo "Note: Lint warnings in $example"
            cd "$GITHUB_WORKSPACE"
          fi
        done

    - name: Run serve validation tests
      run: |
        pytest tests/integration/test_serve_validation.py -v --timeout=60
      timeout-minutes: 3

  # PostgreSQL unit tests
  postgres-tests:
    name: PostgreSQL Tests
    runs-on: ubuntu-latest
    needs: [lint]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: dazzle
          POSTGRES_PASSWORD: dazzle_test
          POSTGRES_DB: dazzle_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,mobile,postgres]"
        pip install pygls || true

    - name: Run tests with PostgreSQL
      env:
        DATABASE_URL: postgresql://dazzle:dazzle_test@localhost:5432/dazzle_test
      run: |
        pytest -v --cov=src/dazzle --cov-report=term-missing -m "not e2e" -x

  # Runtime E2E: CRUD tests + Tier 1 DSL tests against PostgreSQL
  e2e-runtime:
    name: E2E Runtime (PostgreSQL)
    runs-on: ubuntu-latest
    needs: [python-tests, lint, security-tests]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: dazzle
          POSTGRES_PASSWORD: dazzle_test
          POSTGRES_DB: dazzle_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://dazzle:dazzle_test@localhost:5432/dazzle_test
      DAZZLE_SKIP_INFRA_CHECK: "1"

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,llm,mcp,mobile,postgres]"

    - name: Run E2E runtime tests
      run: |
        pytest tests/integration/test_runtime_e2e.py -v -m e2e --timeout=180
      timeout-minutes: 10

    - name: Start server for DSL tests
      run: |
        cd examples/simple_task
        python -m dazzle serve --test-mode --local --port 3000 > /tmp/dazzle-server.log 2>&1 &
        SERVER_PID=$!
        echo "Server PID: $SERVER_PID"
        for i in {1..45}; do
          if curl -s http://localhost:3000/health > /dev/null 2>&1; then
            echo "Server is ready"
            break
          fi
          if ! kill -0 $SERVER_PID 2>/dev/null; then
            echo "Server process died. Logs:"
            cat /tmp/dazzle-server.log
            exit 1
          fi
          echo "Waiting for server... ($i/45)"
          sleep 2
        done
        curl -f http://localhost:3000/health || { echo "Health check failed. Logs:"; cat /tmp/dazzle-server.log; exit 1; }
      timeout-minutes: 3

    - name: Run DSL tests
      run: |
        cd examples/simple_task
        python -m dazzle test run --no-auto-server --verbose
      timeout-minutes: 5
      continue-on-error: true  # Advisory until DOM contract is aligned

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: e2e-runtime-failure
        path: |
          examples/simple_task/testspec.json
          examples/simple_task/test-results/
          /tmp/dazzle-server.log
        retention-days: 7

    - name: Cleanup
      if: always()
      run: |
        pkill -f "dazzle serve" || true

  # Homebrew formula validation - ensures formula is syntactically correct
  # and version numbers are consistent across all files
  homebrew-validation:
    name: Homebrew Formula Validation
    runs-on: macos-14  # Need macOS for brew commands

    steps:
    - uses: actions/checkout@v6

    - name: Extract expected version
      id: version
      run: |
        # Get version from pyproject.toml (source of truth)
        VERSION=$(grep '^version = ' pyproject.toml | head -1 | cut -d'"' -f2)
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Expected version: ${VERSION}"

    - name: Validate formula syntax
      run: |
        # Check Ruby syntax
        ruby -c homebrew/dazzle.rb || { echo "ERROR: Formula has Ruby syntax errors"; exit 1; }
        echo "✓ Formula syntax is valid"

    - name: Check version consistency
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"

        # Check formula version (skip PLACEHOLDER check - handled at release time)
        FORMULA_VERSION=$(grep 'version "' homebrew/dazzle.rb | head -1 | cut -d'"' -f2)

        # Formula may have PLACEHOLDER_VERSION before release
        if [[ "${FORMULA_VERSION}" == "PLACEHOLDER_VERSION" ]]; then
          echo "Note: Formula has placeholder version (will be updated at release time)"
        elif [[ "${FORMULA_VERSION}" != "${VERSION}" ]]; then
          echo "WARNING: Formula version (${FORMULA_VERSION}) differs from pyproject.toml (${VERSION})"
          echo "This may be expected if preparing a release"
        else
          echo "✓ Formula version matches pyproject.toml: ${VERSION}"
        fi

        echo "✓ Version consistency check passed"

    - name: Validate formula structure
      run: |
        # Ensure required sections exist
        echo "Checking required formula sections..."

        grep -q 'class Dazzle < Formula' homebrew/dazzle.rb || { echo "ERROR: Missing Dazzle class"; exit 1; }
        grep -q 'desc "' homebrew/dazzle.rb || { echo "ERROR: Missing description"; exit 1; }
        grep -q 'homepage "' homebrew/dazzle.rb || { echo "ERROR: Missing homepage"; exit 1; }
        grep -q 'def install' homebrew/dazzle.rb || { echo "ERROR: Missing install method"; exit 1; }
        grep -q 'test do' homebrew/dazzle.rb || { echo "ERROR: Missing test block"; exit 1; }
        grep -q 'resource "pydantic-core"' homebrew/dazzle.rb || { echo "ERROR: Missing pydantic-core resource"; exit 1; }

        echo "✓ All required formula sections present"

    - name: Check for common issues
      run: |
        # Check for unexpanded shell variables (shouldn't happen in template)
        if grep -E '\$\{[A-Z_]+\}' homebrew/dazzle.rb | grep -v 'PLACEHOLDER'; then
          echo "WARNING: Found unexpanded shell variables"
        fi

        # Check for hardcoded paths that should be variables
        if grep -E '/usr/local|/opt/homebrew' homebrew/dazzle.rb; then
          echo "WARNING: Found hardcoded paths - use Homebrew variables instead"
        fi

        # Ensure Python version dependency is reasonable
        PYTHON_DEP=$(grep 'depends_on "python@' homebrew/dazzle.rb | head -1)
        echo "Python dependency: ${PYTHON_DEP}"

        echo "✓ Formula passed common issue checks"

    - name: Validate PyPI wheel URLs
      run: |
        echo "Checking PyPI wheel URLs in formula..."

        # Extract and validate all PyPI URLs (skip PLACEHOLDERs)
        URLS=$(grep -oE 'https://files.pythonhosted.org/[^"]+\.whl' homebrew/dazzle.rb || true)

        if [ -z "$URLS" ]; then
          echo "Note: No PyPI wheel URLs found (may be using placeholders)"
          exit 0
        fi

        FAILED=0
        for url in $URLS; do
          echo -n "  Checking $url... "
          if curl -sIf "$url" > /dev/null 2>&1; then
            echo "✓"
          else
            echo "✗ INVALID"
            FAILED=1
          fi
        done

        if [ $FAILED -eq 1 ]; then
          echo "ERROR: One or more PyPI wheel URLs are invalid!"
          exit 1
        fi

        echo "✓ All PyPI wheel URLs are valid"
