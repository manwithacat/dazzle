name: Issue Triage

on:
  issues:
    types: [opened]

# Prevent concurrent runs on same issue
concurrency:
  group: issue-triage-${{ github.event.issue.number }}
  cancel-in-progress: true

# Required permissions for issue management
permissions:
  issues: write
  contents: read

jobs:
  triage-issue:
    name: Triage New Issue
    runs-on: ubuntu-latest

    steps:
    - name: Add Triage Label
      uses: actions/github-script@v8
      continue-on-error: true
      with:
        script: |
          const { owner, repo } = context.repo;
          const issueNumber = context.payload.issue.number;
          const issueLabels = context.payload.issue.labels.map(l => l.name);

          // Add needs-triage if not already labeled with a type
          const typeLabels = ['bug', 'enhancement', 'documentation', 'question'];
          const hasTypeLabel = typeLabels.some(label => issueLabels.includes(label));

          if (!hasTypeLabel) {
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: ['needs-triage'],
              });
              console.log('Added needs-triage label');
            } catch (error) {
              console.log(`Note: Could not add label (may not exist yet): ${error.message}`);
            }
          }

    - name: Welcome and Guide
      uses: actions/github-script@v8
      continue-on-error: true
      with:
        script: |
          const { owner, repo } = context.repo;
          const issueNumber = context.payload.issue.number;
          const issueBody = context.payload.issue.body || '';
          const issueLabels = context.payload.issue.labels.map(l => l.name);
          const author = context.payload.issue.user.login;

          // Check for AI assistance indicators
          const aiPatterns = [
            /AI Agent Used/i,
            /Claude/i,
            /ChatGPT/i,
            /Copilot/i,
            /Gemini/i,
            /investigated with/i,
            /analysis by/i,
          ];

          const hasAiIndication = aiPatterns.some(pattern => pattern.test(issueBody));

          // Build welcome message
          let body = `Thanks for opening this issue, @${author}!\n\n`;

          if (issueLabels.includes('bug') || issueLabels.includes('enhancement')) {
            body += `### Next Steps\n\n`;

            if (!hasAiIndication) {
              body += `This issue would benefit from AI-assisted investigation. You can:\n\n`;
              body += `1. **Assign to Copilot**: Click "Assignees" and select \`@copilot\` to have GitHub Copilot investigate and create a PR\n`;
              body += `2. **Investigate with AI**: Use Claude, ChatGPT, or another AI to help analyze the issue and update your description\n\n`;
            } else {
              body += `We detected AI assistance in your issue - great job following our contribution guidelines!\n\n`;
              body += `**To move forward**: A maintainer will review, or you can assign \`@copilot\` to start implementation.\n\n`;
            }

            body += `### Copilot Assignment\n\n`;
            body += `When you assign this issue to Copilot, it will:\n`;
            body += `- Explore the codebase to understand the context\n`;
            body += `- Create a draft PR with proposed changes\n`;
            body += `- Run tests and linting automatically\n\n`;
            body += `See our [contribution guidelines](../blob/main/CONTRIBUTING.md) for more details.\n`;
          } else {
            body += `A maintainer will review this shortly. `;
            body += `If this is a bug or feature request, please use our [issue templates](../issues/new/choose) for faster processing.\n`;
          }

          // Post comment (best effort)
          try {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: body,
            });
            console.log('Posted welcome comment');
          } catch (error) {
            console.log(`Note: Could not post comment: ${error.message}`);
          }

          // Add label if no AI indication found (best effort)
          if (!hasAiIndication && (issueLabels.includes('bug') || issueLabels.includes('enhancement'))) {
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: ['needs-ai-assistance'],
              });
              console.log('Added needs-ai-assistance label');
            } catch (error) {
              console.log(`Note: Could not add label: ${error.message}`);
            }
          }
