name: AI Co-Authorship Check

on:
  pull_request:
    types: [opened, edited, synchronize]

# Prevent concurrent runs on same PR
concurrency:
  group: ai-coauthor-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# Required permissions for posting comments and reading PR data
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-ai-coauthorship:
    name: Verify AI Co-Authorship
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Check for AI Co-Authorship
      id: ai-check
      uses: actions/github-script@v8
      with:
        script: |
          const { owner, repo } = context.repo;
          const prNumber = context.payload.pull_request.number;
          const prTitle = context.payload.pull_request.title;
          const prAuthor = context.payload.pull_request.user.login;
          const prBody = context.payload.pull_request.body || '';

          // Copilot coding agent creates PRs directly - these are inherently AI-authored
          const COPILOT_AUTHORS = [
            'copilot-swe-agent',
            'github-actions[bot]',
          ];

          // Exempt patterns (bots, automated PRs, trivial changes)
          const EXEMPT_PATTERNS = [
            /^\[bot\]/i,
            /^chore\(deps\)/i,
            /^bump/i,
            /^typo/i,
            /dependabot/i,
            /renovate/i,
            /copilot/i,
          ];

          // AI co-authorship patterns in commits
          const COMMIT_AI_PATTERNS = [
            // Co-Authored-By trailers
            /Co-Authored-By:.*Claude/i,
            /Co-Authored-By:.*ChatGPT/i,
            /Co-Authored-By:.*Copilot/i,
            /Co-Authored-By:.*Gemini/i,
            /Co-Authored-By:.*Cursor/i,
            /Co-Authored-By:.*<.*@anthropic\.com>/i,
            /Co-Authored-By:.*<.*@openai\.com>/i,
            /Co-Authored-By:.*<.*@github\.com>/i,
            /Co-Authored-By:.*<.*@cursor\.com>/i,
            /Co-Authored-By:.*AI\s*(Assistant)?/i,
            // Generated markers
            /ü§ñ.*Generated with/i,
            /Generated with.*Claude/i,
            /Generated by.*Copilot/i,
          ];

          // AI patterns in PR description
          const PR_AI_PATTERNS = [
            /## AI Assistance/i,
            /AI Agent Used:/i,
            /How AI Helped/i,
            /Claude Code/i,
            /ChatGPT/i,
            /GitHub Copilot/i,
            /Copilot coding agent/i,
            /Gemini/i,
            /Cursor AI/i,
            /Windsurf/i,
            /Aider/i,
          ];

          let result = {
            passed: false,
            reason: '',
            details: [],
          };

          // Check 1: Is this a Copilot agent PR?
          if (COPILOT_AUTHORS.includes(prAuthor)) {
            result.passed = true;
            result.reason = 'copilot_agent';
            result.details.push(`PR created by Copilot coding agent (${prAuthor})`);
          }

          // Check 2: Is PR author or title exempt?
          if (!result.passed) {
            for (const pattern of EXEMPT_PATTERNS) {
              if (pattern.test(prTitle) || pattern.test(prAuthor)) {
                result.passed = true;
                result.reason = 'exempt';
                result.details.push(`PR exempt: matched ${pattern}`);
                break;
              }
            }
          }

          // Check 3: PR description mentions AI
          if (!result.passed) {
            for (const pattern of PR_AI_PATTERNS) {
              if (pattern.test(prBody)) {
                result.passed = true;
                result.reason = 'pr_description';
                result.details.push('Found AI attribution in PR description');
                break;
              }
            }
          }

          // Check 4: Commits have Co-Authored-By
          if (!result.passed) {
            const commits = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: prNumber,
            });

            for (const commit of commits.data) {
              const message = commit.commit.message;
              for (const pattern of COMMIT_AI_PATTERNS) {
                if (pattern.test(message)) {
                  result.passed = true;
                  result.reason = 'commit_trailer';
                  result.details.push(`Found AI co-authorship in commit ${commit.sha.substring(0, 7)}`);
                  break;
                }
              }
              if (result.passed) break;
            }
          }

          // Set outputs
          core.setOutput('passed', result.passed);
          core.setOutput('reason', result.reason);
          core.setOutput('details', result.details.join('\n'));

          return result;

    - name: Post Check Result
      uses: actions/github-script@v8
      if: always()
      with:
        script: |
          const passed = ${{ steps.ai-check.outputs.passed }};
          const reason = '${{ steps.ai-check.outputs.reason }}';

          let body;
          if (passed) {
            const emoji = reason === 'copilot_agent' ? 'ü§ñ' : '‚úÖ';
            const reasonText = {
              'copilot_agent': 'This PR was created by GitHub Copilot coding agent.',
              'exempt': 'This PR is exempt from the AI co-authorship requirement.',
              'pr_description': 'AI assistance documented in PR description.',
              'commit_trailer': 'AI co-authorship found in commit messages.',
            }[reason] || 'AI co-authorship verified.';

            body = `### ${emoji} AI Co-Authorship Check\n\n${reasonText}\n\nThank you for following our [AI co-authorship policy](../blob/main/CONTRIBUTING.md#-ai-co-authorship-requirement)!`;
          } else {
            body = '### ‚ùå AI Co-Authorship Check\n\n' +
              '**This PR is missing AI co-authorship attribution.**\n\n' +
              'DAZZLE requires all contributions to be co-authored with an AI agent.\n\n' +
              '#### Quick Fix Options\n\n' +
              '**Option 1: Assign to Copilot**\n' +
              'Close this PR and [assign the issue to `@copilot`](../blob/main/CONTRIBUTING.md#copilot-coding-agent) instead.\n\n' +
              '**Option 2: Add commit trailer**\n```\nCo-Authored-By: Claude <noreply@anthropic.com>\n```\n\n' +
              '**Option 3: Update PR description**\n' +
              'Add an "AI Assistance" section describing how AI helped.\n\n' +
              '#### Recognized AI Agents\n' +
              '| Agent | Trailer |\n|-------|---------|' +
              '\n| Claude | `Co-Authored-By: Claude <noreply@anthropic.com>` |' +
              '\n| GitHub Copilot | `Co-Authored-By: Copilot <copilot@github.com>` |' +
              '\n| ChatGPT | `Co-Authored-By: ChatGPT <noreply@openai.com>` |' +
              '\n| Gemini | `Co-Authored-By: Gemini <noreply@google.com>` |' +
              '\n| Cursor | `Co-Authored-By: Cursor <noreply@cursor.com>` |\n\n' +
              'See our [contribution guidelines](../blob/main/CONTRIBUTING.md#-ai-co-authorship-requirement) for details.';
          }

          // Find and update or create comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
          });

          const botComment = comments.find(c =>
            c.user.type === 'Bot' && c.body.includes('AI Co-Authorship Check')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body,
            });
          }

    - name: Fail if no AI co-authorship
      if: steps.ai-check.outputs.passed != 'true'
      run: |
        echo "::error::AI co-authorship not found. See PR comment for details."
        echo "Documentation: https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md#-ai-co-authorship-requirement"
        exit 1
