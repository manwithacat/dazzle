name: Release CLI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.8.5)'
        required: true
        type: string

permissions:
  contents: write
  statuses: write

jobs:
  build-cli:
    strategy:
      matrix:
        include:
          - os: macos-14       # Apple Silicon (also builds x64 via cross-compile)
            target: darwin-arm64
          - os: ubuntu-latest  # Linux x64
            target: linux-x64
          - os: ubuntu-24.04-arm  # Linux ARM
            target: linux-arm64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        working-directory: cli
        run: bun install

      - name: Inject version into package.json
        working-directory: cli
        run: |
          # Update package.json with the version from git tag
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Injecting version ${VERSION} into package.json"

          # Use jq if available, otherwise sed
          if command -v jq &> /dev/null; then
            jq ".version = \"${VERSION}\"" package.json > package.json.tmp && mv package.json.tmp package.json
          else
            sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"${VERSION}\"/" package.json
            rm -f package.json.bak
          fi

          echo "Updated package.json:"
          grep '"version"' package.json

      - name: Build CLI binary
        working-directory: cli
        run: |
          bun build src/index.ts --compile --outfile=dist/dazzle

          # Create tarball
          cd dist
          tar -czvf dazzle-${{ matrix.target }}.tar.gz dazzle

          # Calculate SHA256
          if [[ "$OSTYPE" == "darwin"* ]]; then
            shasum -a 256 dazzle-${{ matrix.target }}.tar.gz > dazzle-${{ matrix.target }}.tar.gz.sha256
          else
            sha256sum dazzle-${{ matrix.target }}.tar.gz > dazzle-${{ matrix.target }}.tar.gz.sha256
          fi

      # On macOS ARM, also build for x64 (cross-compile)
      - name: Build CLI binary (x64 cross-compile)
        if: matrix.target == 'darwin-arm64'
        working-directory: cli
        run: |
          bun build src/index.ts --compile --target=bun-darwin-x64 --outfile=dist/dazzle-x64

          cd dist
          mv dazzle-x64 dazzle
          tar -czvf dazzle-darwin-x64.tar.gz dazzle
          shasum -a 256 dazzle-darwin-x64.tar.gz > dazzle-darwin-x64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: dazzle-${{ matrix.target }}
          path: |
            cli/dist/dazzle-${{ matrix.target }}.tar.gz
            cli/dist/dazzle-${{ matrix.target }}.tar.gz.sha256

      - name: Upload x64 artifact (cross-compiled)
        if: matrix.target == 'darwin-arm64'
        uses: actions/upload-artifact@v6
        with:
          name: dazzle-darwin-x64
          path: |
            cli/dist/dazzle-darwin-x64.tar.gz
            cli/dist/dazzle-darwin-x64.tar.gz.sha256

  create-release:
    needs: build-cli
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create source tarball
        run: |
          git archive --format=tar.gz --prefix=dazzle-${{ steps.version.outputs.VERSION }}/ HEAD > dazzle-source.tar.gz
          sha256sum dazzle-source.tar.gz > dazzle-source.tar.gz.sha256

      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## DAZZLE v${{ steps.version.outputs.VERSION }}

          ### What's New
          - 50x faster CLI startup (Bun-compiled native binary)
          - LLM-friendly JSON output with agent hints
          - Simplified command structure

          ### Installation

          **Homebrew (recommended):**
          ```bash
          brew install manwithacat/tap/dazzle
          ```

          **Manual:**
          Download the appropriate binary for your platform and add to PATH.

          ### Platforms
          - macOS ARM64 (Apple Silicon)
          - macOS x64 (Intel)
          - Linux x64
          - Linux ARM64

          ### SHA256 Checksums
          See individual `.sha256` files for verification.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: DAZZLE v${{ steps.version.outputs.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'alpha') }}
          files: |
            artifacts/dazzle-darwin-arm64/*
            artifacts/dazzle-darwin-x64/*
            artifacts/dazzle-linux-x64/*
            artifacts/dazzle-linux-arm64/*
            dazzle-source.tar.gz
            dazzle-source.tar.gz.sha256

  update-homebrew:
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v6
        with:
          repository: manwithacat/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Download checksums from release
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          BASE_URL="https://github.com/manwithacat/dazzle/releases/download/v${VERSION}"

          # Wait for release assets to be available (sometimes takes a moment)
          sleep 10

          # Download SHA256 files with retry for CLI binaries
          for i in {1..5}; do
            curl -sL "${BASE_URL}/dazzle-darwin-arm64.tar.gz.sha256" -o darwin-arm64.sha256 && break
            echo "Retry $i..."
            sleep 5
          done

          curl -sL "${BASE_URL}/dazzle-darwin-x64.tar.gz.sha256" -o darwin-x64.sha256
          curl -sL "${BASE_URL}/dazzle-linux-arm64.tar.gz.sha256" -o linux-arm64.sha256
          curl -sL "${BASE_URL}/dazzle-linux-x64.tar.gz.sha256" -o linux-x64.sha256

          # IMPORTANT: Calculate source SHA256 from GitHub's tag archive URL
          # NOT from the release asset - they have different metadata and thus different hashes
          SOURCE_SHA256=$(curl -sL "https://github.com/manwithacat/dazzle/archive/refs/tags/v${VERSION}.tar.gz" | sha256sum | cut -d' ' -f1)
          echo "SHA256_SOURCE=${SOURCE_SHA256}" >> $GITHUB_ENV

          # Extract CLI binary hashes
          echo "SHA256_DARWIN_ARM64=$(cut -d' ' -f1 darwin-arm64.sha256)" >> $GITHUB_ENV
          echo "SHA256_DARWIN_X64=$(cut -d' ' -f1 darwin-x64.sha256)" >> $GITHUB_ENV
          echo "SHA256_LINUX_ARM64=$(cut -d' ' -f1 linux-arm64.sha256)" >> $GITHUB_ENV
          echo "SHA256_LINUX_X64=$(cut -d' ' -f1 linux-x64.sha256)" >> $GITHUB_ENV

          # Debug: show what we got
          echo "Source SHA256 (from tag URL): ${SOURCE_SHA256}"
          echo "Darwin ARM64 SHA256: $(cat darwin-arm64.sha256)"

      - name: Generate new formula
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          cat > Formula/dazzle.rb << FORMULA_EOF
          # DAZZLE Homebrew Formula v${VERSION}
          #
          # Installation: brew install manwithacat/tap/dazzle
          # Or from this file: brew install ./homebrew/dazzle.rb
          #
          # v${VERSION} Architecture:
          # - CLI: Bun-compiled native binary (50x faster startup)
          # - Runtime: Python package for DSL parsing and code generation
          #
          # The binary is built from cli/ using \`bun build --compile\`
          # Python is invoked only when DSL operations are needed

          class Dazzle < Formula
            include Language::Python::Virtualenv

            desc "DSL-first application framework with LLM-assisted development"
            homepage "https://github.com/manwithacat/dazzle"
            version "${VERSION}"
            license "MIT"

            # Source tarball for Python package
            url "https://github.com/manwithacat/dazzle/archive/refs/tags/v${VERSION}.tar.gz"
            sha256 "${SHA256_SOURCE}"

            # Pre-compiled CLI binaries for each platform
            resource "cli-binary" do
              on_macos do
                on_arm do
                  url "https://github.com/manwithacat/dazzle/releases/download/v${VERSION}/dazzle-darwin-arm64.tar.gz"
                  sha256 "${SHA256_DARWIN_ARM64}"
                end
                on_intel do
                  url "https://github.com/manwithacat/dazzle/releases/download/v${VERSION}/dazzle-darwin-x64.tar.gz"
                  sha256 "${SHA256_DARWIN_X64}"
                end
              end
              on_linux do
                on_arm do
                  url "https://github.com/manwithacat/dazzle/releases/download/v${VERSION}/dazzle-linux-arm64.tar.gz"
                  sha256 "${SHA256_LINUX_ARM64}"
                end
                on_intel do
                  url "https://github.com/manwithacat/dazzle/releases/download/v${VERSION}/dazzle-linux-x64.tar.gz"
                  sha256 "${SHA256_LINUX_X64}"
                end
              end
            end

            # pydantic-core requires Rust to build from source, so use pre-built wheels
            resource "pydantic-core" do
              on_macos do
                on_arm do
                  url "https://files.pythonhosted.org/packages/14/de/866bdce10ed808323d437612aca1ec9971b981e1c52e5e42ad9b8e17a6f6/pydantic_core-2.23.4-cp312-cp312-macosx_11_0_arm64.whl"
                  sha256 "f69a8e0b033b747bb3e36a44e7732f0c99f7edd5cea723d45bc0d6e95377ffee"
                end
                on_intel do
                  url "https://files.pythonhosted.org/packages/74/7b/8e315f80666194b354966ec84b7d567da77ad927ed6323db4006cf915f3f/pydantic_core-2.23.4-cp312-cp312-macosx_10_12_x86_64.whl"
                  sha256 "f3e0da4ebaef65158d4dfd7d3678aad692f7666877df0002b8a522cdf088f231"
                end
              end
              on_linux do
                on_arm do
                  url "https://files.pythonhosted.org/packages/dc/69/8edd5c3cd48bb833a3f7ef9b81d7666ccddd3c9a635225214e044b6e8281/pydantic_core-2.23.4-cp312-cp312-manylinux_2_17_aarch64.manylinux2014_aarch64.whl"
                  sha256 "723314c1d51722ab28bfcd5240d858512ffd3116449c557a1336cbe3919beb87"
                end
                on_intel do
                  url "https://files.pythonhosted.org/packages/06/c8/7d4b708f8d05a5cbfda3243aad468052c6e99de7d0937c9146c24d9f12e9/pydantic_core-2.23.4-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl"
                  sha256 "128585782e5bfa515c590ccee4b727fb76925dd04a98864182b22e89a4e6ed36"
                end
              end
            end

            # jiter also requires Rust to build - pre-built wheels avoid dylib header issues
            # The jiter dylib has minimal Mach-O headers that cause install_name_tool failures
            resource "jiter" do
              on_macos do
                on_arm do
                  url "https://files.pythonhosted.org/packages/98/6e/e8efa0e78de00db0aee82c0cf9e8b3f2027efd7f8a71f859d8f4be8e98ef/jiter-0.12.0-cp312-cp312-macosx_11_0_arm64.whl"
                  sha256 "5c1860627048e302a528333c9307c818c547f214d8659b0705d2195e1a94b274"
                end
                on_intel do
                  url "https://files.pythonhosted.org/packages/92/c9/5b9f7b4983f1b542c64e84165075335e8a236fa9e2ea03a0c79780062be8/jiter-0.12.0-cp312-cp312-macosx_10_12_x86_64.whl"
                  sha256 "305e061fa82f4680607a775b2e8e0bcb071cd2205ac38e6ef48c8dd5ebe1cf37"
                end
              end
              on_linux do
                on_arm do
                  url "https://files.pythonhosted.org/packages/20/26/894cd88e60b5d58af53bec5c6759d1292bd0b37a8b5f60f07abf7a63ae5f/jiter-0.12.0-cp312-cp312-manylinux_2_17_aarch64.manylinux2014_aarch64.whl"
                  sha256 "df37577a4f8408f7e0ec3205d2a8f87672af8f17008358063a4d6425b6081ce3"
                end
                on_intel do
                  url "https://files.pythonhosted.org/packages/71/b3/7a69d77943cc837d30165643db753471aff5df39692d598da880a6e51c24/jiter-0.12.0-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl"
                  sha256 "4321e8a3d868919bcb1abb1db550d41f2b5b326f72df29e53b2df8b006eb9403"
                end
              end
            end

            depends_on "python@3.12"

            def install
              # Install Python package in virtualenv
              venv = virtualenv_create(libexec, "python3.12")

              # Install pydantic-core wheel first (requires Rust to build from source)
              resource("pydantic-core").stage do
                wheel = Dir["*.whl"].first
                odie "pydantic-core wheel not found in resource" unless wheel

                system venv.root/"bin/python", "-m", "pip", "install",
                       "--no-deps", "--no-compile",
                       wheel
              end

              # Install jiter wheel (dylib has minimal Mach-O headers that break install_name_tool)
              resource("jiter").stage do
                wheel = Dir["*.whl"].first
                odie "jiter wheel not found in resource" unless wheel

                system venv.root/"bin/python", "-m", "pip", "install",
                       "--no-deps", "--no-compile",
                       wheel
              end

              # Install dazzle with all optional dependencies (mcp, llm, lsp)
              # pip will resolve transitive dependencies and use our pre-installed pydantic-core and jiter
              # IMPORTANT: lsp is required for VS Code extension Language Server Protocol support
              system venv.root/"bin/python", "-m", "pip", "install",
                     "--no-compile",
                     "#{buildpath}[mcp,llm,lsp]"

              # Install the pre-compiled CLI binary
              resource("cli-binary").stage do
                bin.install "dazzle" => "dazzle-bin"
              end

              # Create wrapper script that sets up Python path
              (bin/"dazzle").write <<~EOS
                #!/bin/bash
                export DAZZLE_PYTHON="#{libexec}/bin/python"
                export PYTHONPATH="#{libexec}/lib/python3.12/site-packages:\$PYTHONPATH"
                exec "#{bin}/dazzle-bin" "\$@"
              EOS
              chmod 0755, bin/"dazzle"
            end

            def post_install
              # Register MCP server with Claude Code
              system libexec/"bin/python", "-m", "dazzle.cli", "mcp-setup"
            rescue StandardError => e
              opoo "Could not register MCP server: #{e.message}"
              opoo "You can manually register later with: dazzle mcp-setup"
            end

            def caveats
              <<~EOS
                DAZZLE v${VERSION} has been installed!

                What's New:
                  - 50x faster CLI startup (Bun-compiled binary)
                  - LLM-friendly JSON output (pipe to agents)
                  - Simplified command structure

                Quick start:
                  dazzle new my-project
                  cd my-project
                  dazzle dev

                Commands:
                  dazzle new      Create a new project
                  dazzle dev      Start development server (API + UI)
                  dazzle check    Validate DSL files
                  dazzle build    Build for production
                  dazzle eject    Generate standalone code
                  dazzle test     Run E2E tests

                JSON output (for AI agents):
                  dazzle check --json
                  dazzle show entities --json

                MCP Server (Claude Code):
                  The DAZZLE MCP server has been automatically registered.
                  Check status: dazzle mcp-check

                Documentation:
                  https://github.com/manwithacat/dazzle
              EOS
            end

            test do
              # Test fast path (no Python needed)
              output = shell_output("#{bin}/dazzle version")
              assert_match "${VERSION}", output

              # Test Python integration
              output = shell_output("#{bin}/dazzle version --full")
              assert_match "python_available", output

              # Test LSP dependencies are installed (critical for VS Code extension)
              # This catches the regression where [lsp] extras were missing from pip install
              system libexec/"bin/python", "-c", "import dazzle.lsp"

              # Test basic functionality
              (testpath/"dazzle.toml").write <<~TOML
                [project]
                name = "test"
                version = "0.1.0"
              TOML

              (testpath/"dsl").mkpath
              (testpath/"dsl/app.dsl").write <<~DSL
                module test
                app test "Test App"

                entity Task "Task":
                  id: uuid pk
                  title: str(200) required
              DSL

              # Test validation
              output = shell_output("#{bin}/dazzle check --json")
              assert_match '"success"', output
            end
          end
          FORMULA_EOF

      - name: Validate formula
        run: |
          echo "=== Generated Formula ==="
          head -50 Formula/dazzle.rb
          echo "..."
          echo "=== Checking for variables ==="
          # Fail if any shell variables weren't expanded
          if grep -E '\$\{[A-Z_]+\}' Formula/dazzle.rb; then
            echo "ERROR: Unexpanded variables found in formula!"
            exit 1
          fi
          echo "Formula looks good!"

      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/dazzle.rb
          git diff --staged --stat
          git commit -m "Update dazzle to v${{ steps.version.outputs.VERSION }}"
          git push

  # Post-release verification - tests actual Homebrew installation
  verify-homebrew:
    needs: update-homebrew
    runs-on: macos-14  # Apple Silicon

    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Wait for tap to be available
        run: |
          echo "Waiting 30s for homebrew-tap update to propagate..."
          sleep 30

      - name: Install from tap
        run: |
          # Update Homebrew
          brew update

          # Tap and install
          brew tap manwithacat/tap

          # Install with verbose output
          # Note: jiter dylib has minimal Mach-O headers that cause linkage warnings
          # This is a known issue and doesn't affect functionality
          brew install --verbose manwithacat/tap/dazzle || {
            echo "⚠ Installation had warnings (likely jiter dylib linkage)"
            echo "Checking if dazzle was installed despite warnings..."
            if brew list dazzle &>/dev/null; then
              echo "✓ dazzle is installed, continuing"
            else
              echo "✗ dazzle not found, installation failed"
              exit 1
            fi
          }

          echo "✓ Installation completed"

      - name: Verify CLI version
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Check version output
          OUTPUT=$(dazzle version)
          echo "Version output: ${OUTPUT}"

          if [[ ! "${OUTPUT}" =~ "${VERSION}" ]]; then
            echo "ERROR: Installed version doesn't match expected ${VERSION}"
            exit 1
          fi
          echo "✓ Version matches: ${VERSION}"

      - name: Test Python integration
        run: |
          # Test that Python is properly configured
          OUTPUT=$(dazzle version --full)
          echo "Full version output: ${OUTPUT}"

          if [[ ! "${OUTPUT}" =~ "python_available" ]]; then
            echo "ERROR: Python integration not working"
            exit 1
          fi
          echo "✓ Python integration working"

      - name: Test DSL validation
        run: |
          # Create test project
          mkdir -p test-project/dsl

          cat > test-project/dazzle.toml << 'EOF'
          [project]
          name = "test"
          version = "0.1.0"
          root = "test"
          EOF

          cat > test-project/dsl/app.dsl << 'EOF'
          module test
          app test "Test App"

          entity Task "Task":
            id: uuid pk
            title: str(200) required
            done: bool=false
          EOF

          cd test-project

          # Capture output even if command fails (CLI returns exit 1 on validation errors)
          OUTPUT=$(dazzle check --json 2>&1) || true
          echo "Check output: ${OUTPUT}"

          # Check for success in JSON output
          if [[ "${OUTPUT}" =~ '"success": true' ]] || [[ "${OUTPUT}" =~ '"success":true' ]]; then
            echo "✓ DSL validation working"
          else
            echo "ERROR: DSL validation failed"
            echo "Full output:"
            echo "${OUTPUT}"
            exit 1
          fi

      - name: Test performance (startup time)
        run: |
          # Measure CLI startup time (should be <500ms for simple commands)
          echo "Measuring startup time..."

          START=$(python3 -c 'import time; print(time.time())')
          dazzle version > /dev/null
          END=$(python3 -c 'import time; print(time.time())')

          DURATION=$(python3 -c "print(f'{($END - $START) * 1000:.0f}')")
          echo "Startup time: ${DURATION}ms"

          if [ "${DURATION}" -gt 2000 ]; then
            echo "WARNING: CLI startup is slow (${DURATION}ms > 2000ms)"
            # Don't fail, just warn
          else
            echo "✓ Startup time acceptable: ${DURATION}ms"
          fi

      - name: Report success
        if: success()
        run: |
          echo "============================================"
          echo "✓ Homebrew installation verified successfully"
          echo "  Version: ${{ steps.version.outputs.VERSION }}"
          echo "  Platform: macOS ARM64"
          echo "============================================"

      - name: Create status check
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            // Create a check run to track homebrew verification status
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: '${{ job.status }}' === 'success' ? 'success' : 'failure',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
              description: 'Homebrew installation verification',
              context: 'homebrew-verification'
            });

  # Trigger tap repo validation (cross-repo)
  trigger-tap-validation:
    needs: update-homebrew
    runs-on: ubuntu-latest

    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger tap validation workflow
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: manwithacat/homebrew-tap
          event-type: validate-formula
          client-payload: '{"version": "${{ steps.version.outputs.VERSION }}", "source_run_id": "${{ github.run_id }}"}'
