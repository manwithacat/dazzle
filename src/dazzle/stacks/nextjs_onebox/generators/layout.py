"""
Layout generator for Next.js Onebox.

Generates:
- src/app/layout.tsx (root layout)
- src/providers/index.tsx (providers wrapper)
- src/components/nav.tsx (navigation)
- src/components/sidebar.tsx (sidebar navigation)
"""

from pathlib import Path

from ....core import ir
from ...base.generator import Generator, GeneratorResult


class LayoutGenerator(Generator):
    """Generates layout and navigation components."""

    def generate(self) -> GeneratorResult:
        """Generate layout files."""
        result = GeneratorResult()

        self._generate_root_layout(result)
        self._generate_providers(result)
        self._generate_nav(result)
        self._generate_sidebar(result)
        self._generate_health_api(result)
        self._copy_branding_assets(result)

        return result

    def _generate_root_layout(self, result: GeneratorResult) -> None:
        """Generate root layout."""
        app_title = self.spec.title or self.spec.name

        content = f'''// Root Layout
// Generated by DAZZLE Next.js Onebox Stack

import type {{ Metadata }} from "next";
import {{ Inter }} from "next/font/google";
import "./globals.css";

const inter = Inter({{ subsets: ["latin"] }});

export const metadata: Metadata = {{
  title: "{app_title}",
  description: "Generated with DAZZLE",
  icons: {{
    icon: "/dazzle-favicon.svg",
  }},
}};

export default function RootLayout({{
  children,
}}: {{
  children: React.ReactNode;
}}) {{
  return (
    <html lang="en">
      <body className={{inter.className}}>
        {{children}}
      </body>
    </html>
  );
}}
'''
        path = self.output_dir / "src" / "app" / "layout.tsx"
        self._write_file(path, content)
        result.add_file(path)

    def _generate_providers(self, result: GeneratorResult) -> None:
        """Generate providers wrapper."""
        content = """"use client";

// Providers
// Generated by DAZZLE Next.js Onebox Stack

import { type ReactNode } from "react";

interface ProvidersProps {
  children: ReactNode;
}

export function Providers({ children }: ProvidersProps) {
  return <>{children}</>;
}
"""
        path = self.output_dir / "src" / "providers" / "index.tsx"
        self._write_file(path, content)
        result.add_file(path)

    def _generate_nav(self, result: GeneratorResult) -> None:
        """Generate navigation component."""
        # Build navigation links from surfaces
        nav_links = []
        for surface in self.spec.surfaces:
            if surface.mode in (ir.SurfaceMode.LIST,):
                snake_name = surface.name.lower()
                title = surface.title or surface.name.replace("_", " ").title()
                nav_links.append(f'  {{ href: "/{snake_name}", label: "{title}" }},')

        nav_links_str = "\n".join(nav_links) if nav_links else '  { href: "/", label: "Home" },'

        content = f""""use client";

// Navigation Component
// Generated by DAZZLE Next.js Onebox Stack

import Link from "next/link";
import {{ usePathname }} from "next/navigation";
import {{ Menu, X, LogOut, User }} from "lucide-react";
import {{ useState }} from "react";
import {{ cn }} from "@/lib/utils";
import type {{ AuthUser }} from "@/types/api";

const navLinks = [
{nav_links_str}
];

interface NavProps {{
  user: AuthUser | null;
}}

export function Nav({{ user }}: NavProps) {{
  const pathname = usePathname();
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  return (
    <header className="sticky top-0 z-50 border-b border-gray-200 bg-white">
      <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div className="flex h-16 items-center justify-between">
          {{/* Logo */}}
          <div className="flex items-center gap-3">
            <Link href="/" className="flex items-center gap-3">
              <img
                src="/dazzle-logo.svg"
                alt="DAZZLE Logo"
                className="h-8"
              />
            </Link>
          </div>

          {{/* Desktop Navigation */}}
          <nav className="hidden md:flex md:items-center md:gap-6">
            {{navLinks.map((link) => (
              <Link
                key={{link.href}}
                href={{link.href}}
                className={{cn(
                  "text-sm font-medium transition-colors",
                  pathname === link.href
                    ? "text-blue-600"
                    : "text-gray-600 hover:text-gray-900"
                )}}
              >
                {{link.label}}
              </Link>
            ))}}
          </nav>

          {{/* User Menu */}}
          <div className="flex items-center gap-4">
            {{user ? (
              <div className="flex items-center gap-4">
                <div className="hidden sm:flex sm:items-center sm:gap-2">
                  <User className="h-4 w-4 text-gray-400" />
                  <span className="text-sm text-gray-600">{{user.email}}</span>
                </div>
                <a
                  href="/logout"
                  className="flex items-center gap-1 text-sm text-gray-600 hover:text-gray-900"
                >
                  <LogOut className="h-4 w-4" />
                  <span className="hidden sm:inline">Sign out</span>
                </a>
              </div>
            ) : (
              <Link
                href="/login"
                className="text-sm font-medium text-gray-600 hover:text-gray-900"
              >
                Sign in
              </Link>
            )}}

            {{/* Mobile menu button */}}
            <button
              type="button"
              className="md:hidden p-2 text-gray-600"
              onClick={{() => setMobileMenuOpen(!mobileMenuOpen)}}
            >
              {{mobileMenuOpen ? (
                <X className="h-6 w-6" />
              ) : (
                <Menu className="h-6 w-6" />
              )}}
            </button>
          </div>
        </div>
      </div>

      {{/* Mobile Navigation */}}
      {{mobileMenuOpen && (
        <div className="md:hidden border-t border-gray-200">
          <nav className="flex flex-col p-4 space-y-2">
            {{navLinks.map((link) => (
              <Link
                key={{link.href}}
                href={{link.href}}
                className={{cn(
                  "px-3 py-2 rounded-md text-sm font-medium",
                  pathname === link.href
                    ? "bg-blue-50 text-blue-600"
                    : "text-gray-600 hover:bg-gray-50"
                )}}
                onClick={{() => setMobileMenuOpen(false)}}
              >
                {{link.label}}
              </Link>
            ))}}
          </nav>
        </div>
      )}}
    </header>
  );
}}
"""
        path = self.output_dir / "src" / "components" / "nav.tsx"
        self._write_file(path, content)
        result.add_file(path)

    def _generate_sidebar(self, result: GeneratorResult) -> None:
        """Generate sidebar component."""
        # Build sidebar links from surfaces
        sidebar_links = []
        for surface in self.spec.surfaces:
            if surface.mode in (ir.SurfaceMode.LIST,):
                snake_name = surface.name.lower()
                title = surface.title or surface.name.replace("_", " ").title()
                sidebar_links.append(
                    f'  {{ href: "/{snake_name}", label: "{title}", icon: List }},'
                )

        sidebar_links_str = (
            "\n".join(sidebar_links)
            if sidebar_links
            else '  { href: "/", label: "Home", icon: Home },'
        )

        content = f""""use client";

// Sidebar Component
// Generated by DAZZLE Next.js Onebox Stack

import Link from "next/link";
import {{ usePathname }} from "next/navigation";
import {{ Home, List, type LucideIcon }} from "lucide-react";
import {{ cn }} from "@/lib/utils";

interface SidebarLink {{
  href: string;
  label: string;
  icon: LucideIcon;
}}

const sidebarLinks: SidebarLink[] = [
{sidebar_links_str}
];

interface SidebarProps {{
  isOpen?: boolean;
  onClose?: () => void;
}}

export function Sidebar({{ isOpen = true, onClose }}: SidebarProps) {{
  const pathname = usePathname();

  return (
    <aside
      className={{cn(
        "fixed inset-y-0 left-0 z-50 w-64 transform bg-white shadow-lg transition-transform lg:relative lg:translate-x-0",
        isOpen ? "translate-x-0" : "-translate-x-full"
      )}}
    >
      <div className="flex h-full flex-col">
        {{/* Sidebar Header */}}
        <div className="flex h-16 items-center border-b border-gray-200 px-6">
          <span className="text-lg font-semibold text-gray-900">Menu</span>
        </div>

        {{/* Sidebar Links */}}
        <nav className="flex-1 overflow-y-auto p-4">
          <ul className="space-y-1">
            {{sidebarLinks.map((link) => {{
              const Icon = link.icon;
              const isActive = pathname === link.href;

              return (
                <li key={{link.href}}>
                  <Link
                    href={{link.href}}
                    onClick={{onClose}}
                    className={{cn(
                      "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",
                      isActive
                        ? "bg-blue-50 text-blue-600"
                        : "text-gray-700 hover:bg-gray-100"
                    )}}
                  >
                    <Icon className="h-5 w-5" />
                    {{link.label}}
                  </Link>
                </li>
              );
            }})}}
          </ul>
        </nav>
      </div>
    </aside>
  );
}}
"""
        path = self.output_dir / "src" / "components" / "sidebar.tsx"
        self._write_file(path, content)
        result.add_file(path)

    def _generate_health_api(self, result: GeneratorResult) -> None:
        """Generate health check API route."""
        content = """// Health Check API
// Generated by DAZZLE Next.js Onebox Stack

import { NextResponse } from "next/server";
import { prisma } from "@/lib/db";

export async function GET() {
  try {
    // Check database connection
    await prisma.$queryRaw`SELECT 1`;

    return NextResponse.json({
      status: "healthy",
      timestamp: new Date().toISOString(),
      services: {
        database: "connected",
      },
    });
  } catch (error) {
    return NextResponse.json(
      {
        status: "unhealthy",
        timestamp: new Date().toISOString(),
        services: {
          database: "disconnected",
        },
        error: error instanceof Error ? error.message : "Unknown error",
      },
      { status: 503 }
    );
  }
}
"""
        path = self.output_dir / "src" / "app" / "api" / "health" / "route.ts"
        self._write_file(path, content)
        result.add_file(path)

    def _copy_branding_assets(self, result: GeneratorResult) -> None:
        """Copy DAZZLE branding assets to public directory."""
        import shutil

        # Path to assets in the DAZZLE repo
        assets_dir = Path(__file__).parent.parent.parent.parent.parent / "assets"

        if not assets_dir.exists():
            # Assets don't exist, generate them inline
            self._generate_inline_assets(result)
            return

        # Copy logo
        logo_src = assets_dir / "dazzle-logo.svg"
        if logo_src.exists():
            logo_dest = self.output_dir / "public" / "dazzle-logo.svg"
            logo_dest.parent.mkdir(parents=True, exist_ok=True)
            shutil.copy2(logo_src, logo_dest)
            result.add_file(logo_dest)

        # Copy favicon
        favicon_src = assets_dir / "dazzle-favicon.svg"
        if favicon_src.exists():
            favicon_dest = self.output_dir / "public" / "dazzle-favicon.svg"
            favicon_dest.parent.mkdir(parents=True, exist_ok=True)
            shutil.copy2(favicon_src, favicon_dest)
            result.add_file(favicon_dest)

    def _generate_inline_assets(self, result: GeneratorResult) -> None:
        """Generate branding assets inline if assets directory doesn't exist."""
        # Generate logo
        logo_content = """<svg width="300" height="80" viewBox="0 0 300 80" xmlns="http://www.w3.org/2000/svg">
  <!-- Spark Icon -->
  <g transform="translate(10,10)">
    <circle cx="30" cy="30" r="6" fill="#7B2FF7"/>
    <line x1="30" y1="10" x2="30" y2="0" stroke="#7B2FF7" stroke-width="2"/>
    <line x1="30" y1="60" x2="30" y2="70" stroke="#7B2FF7" stroke-width="2"/>
    <line x1="10" y1="30" x2="0" y2="30" stroke="#7B2FF7" stroke-width="2"/>
    <line x1="60" y1="30" x2="70" y2="30" stroke="#7B2FF7" stroke-width="2"/>
    <line x1="12" y1="12" x2="3" y2="3" stroke="#7B2FF7" stroke-width="2"/>
    <line x1="48" y1="12" x2="57" y2="3" stroke="#7B2FF7" stroke-width="2"/>
    <line x1="12" y1="48" x2="3" y2="57" stroke="#7B2FF7" stroke-width="2"/>
    <line x1="48" y1="48" x2="57" y2="57" stroke="#7B2FF7" stroke-width="2"/>
  </g>

  <!-- DAZZLE Wordmark -->
  <text x="100" y="50" font-family="Inter, sans-serif" font-size="42" fill="#0A0A0C" letter-spacing="4">
    DAZZLE
  </text>
</svg>"""
        logo_path = self.output_dir / "public" / "dazzle-logo.svg"
        self._write_file(logo_path, logo_content)
        result.add_file(logo_path)

        # Generate favicon
        favicon_content = """<svg width="32" height="32" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
  <circle cx="30" cy="30" r="6" fill="#7B2FF7"/>
  <line x1="30" y1="8" x2="30" y2="0" stroke="#7B2FF7" stroke-width="3"/>
  <line x1="30" y1="52" x2="30" y2="60" stroke="#7B2FF7" stroke-width="3"/>
  <line x1="8" y1="30" x2="0" y2="30" stroke="#7B2FF7" stroke-width="3"/>
  <line x1="52" y1="30" x2="60" y2="30" stroke="#7B2FF7" stroke-width="3"/>
</svg>"""
        favicon_path = self.output_dir / "public" / "dazzle-favicon.svg"
        self._write_file(favicon_path, favicon_content)
        result.add_file(favicon_path)
