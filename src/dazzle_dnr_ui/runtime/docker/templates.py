"""
Docker template strings for DNR containers.

Contains Dockerfile templates and docker-compose templates for split container mode.
The actual container runtime code is in dazzle_dnr_ui.runtime.container package.
"""

from __future__ import annotations

# =============================================================================
# Split Container Templates
# =============================================================================

DNR_BACKEND_DOCKERFILE = """# DNR Backend Container
# Generated by Dazzle Native Runtime
FROM python:3.11-slim

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \\
    gcc curl && rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir \\
    fastapi uvicorn[standard] aiosqlite pydantic

# Copy specs
COPY backend_spec.json ./
COPY ui_spec.json ./

# Copy container runtime package
COPY container/ ./container/

RUN mkdir -p /app/.dazzle

EXPOSE {api_port}

ENV PYTHONUNBUFFERED=1
ENV DNR_HOST=0.0.0.0
ENV DNR_API_PORT={api_port}
ENV DNR_DB_PATH=/app/.dazzle/data.db

HEALTHCHECK --interval=10s --timeout=5s --start-period=15s --retries=3 \\
    CMD curl -f http://localhost:{api_port}/health || exit 1

CMD ["python", "-m", "container"]
"""

DNR_FRONTEND_DOCKERFILE = """# DNR Frontend Container
# Generated by Dazzle Native Runtime - Vite dev server
FROM node:20-slim

RUN apt-get update && apt-get install -y --no-install-recommends curl \\
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY package.json vite.config.js ./
RUN npm install

COPY src/ ./src/

EXPOSE {frontend_port}

HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \\
    CMD curl -f http://localhost:{frontend_port} || exit 1

CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
"""

DNR_COMPOSE_TEMPLATE = """# DNR Docker Compose - Split Containers
# Generated by Dazzle Native Runtime
services:
  backend:
    build:
      context: ./backend
    container_name: {container_name}-backend
    ports:
      - "{api_port}:{api_port}"
    volumes:
      - {volume_name}:/app/.dazzle
    environment:
      - DNR_TEST_MODE={test_mode}
      - DNR_API_PORT={api_port}
      - DNR_AUTH_ENABLED={auth_enabled}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{api_port}/health"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 15s

  frontend:
    build:
      context: ./frontend
    container_name: {container_name}-frontend
    ports:
      - "{frontend_port}:{frontend_port}"
    environment:
      - VITE_API_URL=http://host.docker.internal:{api_port}
    depends_on:
      backend:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{frontend_port}"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  {volume_name}:
"""


# =============================================================================
# .dockerignore Template
# =============================================================================

DNR_DOCKERIGNORE = """# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/
ENV/
.venv

# Build
build/
dist/
*.egg-info/

# Testing
.pytest_cache/
.coverage
htmlcov/
.hypothesis/

# IDE
.vscode/
.idea/
*.swp
*.swo

# Git
.git/
.gitignore

# Dazzle artifacts (keep dsl/ and dazzle.toml)
.dazzle/

# Misc
.DS_Store
*.log
.env
.env.*
!.env.example
"""
