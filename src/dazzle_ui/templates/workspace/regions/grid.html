<div class="card bg-base-100 shadow-sm">
  <div class="card-body p-3">
    <h3 class="card-title text-sm">{{ title }}</h3>
    {% if items %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
      {% for item in items %}
      {% set attn = item.get("_attention") if item.get is defined else none %}
      <div class="card card-compact bg-base-200{% if attn %}{% if attn.level == 'critical' %} border-l-4 border-error{% elif attn.level == 'warning' %} border-l-4 border-warning{% elif attn.level == 'notice' %} border-l-4 border-info{% endif %}{% endif %}{% if action_url %} cursor-pointer hover:bg-base-300 transition-colors{% endif %}"
           {% if attn %}title="{{ attn.message }}"{% endif %}
           {% if action_url %}hx-get="{{ action_url | replace('{id}', item.id|string) }}"
           hx-push-url="true" hx-target="body"{% endif %}>
        <div class="card-body">
          <h4 class="card-title text-sm">{{ item[display_key] | default(item.get("name", "Item")) }}</h4>
          {% for col in columns %}
          {% if col.key != display_key %}
          <p class="text-xs">
            <span class="opacity-60">{{ col.label }}:</span>
            {% if col.type == "badge" %}
              <span class="badge badge-sm {{ item[col.key] | badge_class }}">{{ item[col.key] | default("") }}</span>
            {% elif col.type == "bool" %}
              {{ item[col.key] | bool_icon }}
            {% elif col.type == "date" %}
              {{ item[col.key] | dateformat }}
            {% elif col.type == "currency" %}
              {{ item[col.key] | currency }}
            {% elif col.type == "ref" %}
              {% set ref = item[col.key] %}
              {% if ref is mapping %}
                {% set ref_display = ref.get("name") or ref.get("company_name") or ((ref.get("first_name", "") ~ " " ~ ref.get("last_name", "")) | trim) or ref.get("title") or ref.get("label") or ref.get("email") or ref.get("id", "") %}
                {% if col.ref_route and ref.get("id") %}
                  <a href="{{ col.ref_route | replace('{id}', ref.id|string) }}" class="link link-hover link-primary" onclick="event.stopPropagation()">{{ ref_display }}</a>
                {% else %}{{ ref_display }}{% endif %}
              {% elif ref %}{{ ref }}{% else %}-{% endif %}
            {% else %}
              {{ item[col.key] | default("") | truncate_text }}
            {% endif %}
          </p>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-sm opacity-50">{{ empty_message | default("No data available.") }}</p>
    {% endif %}
  </div>
</div>
