<div class="card bg-base-100 shadow-sm">
  <div class="card-body p-3">
    <h3 class="card-title text-sm">{{ title }}</h3>
    <div class="stats stats-vertical lg:stats-horizontal shadow-sm">
      {% for metric in metrics %}
      <div class="stat">
        <div class="stat-title">{{ metric.label }}</div>
        <div class="stat-value text-lg">{{ metric.value }}</div>
        {% if metric.description %}
        <div class="stat-desc">{{ metric.description }}</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% if not metrics %}
    <p class="text-sm opacity-50">{{ empty_message | default("No metrics available.") }}</p>
    {% endif %}
    {% if items and columns %}
    <div class="divider my-1"></div>
    <div class="overflow-x-auto">
      <table class="table table-sm table-zebra">
        <thead>
          <tr>
            {% for col in columns %}
            <th>{{ col.label }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          {% set attn = item.get("_attention") if item.get is defined else none %}
          <tr class="{% if attn %}{% if attn.level == 'critical' %}bg-error/10{% elif attn.level == 'warning' %}bg-warning/10{% elif attn.level == 'notice' %}bg-info/10{% endif %} {% endif %}{% if action_url %}cursor-pointer hover{% endif %}"
              {% if attn %}title="{{ attn.message }}"{% endif %}
              {% if action_url %}hx-get="{{ action_url | replace('{id}', item.id|string) }}"
              hx-push-url="true" hx-target="body"{% endif %}>
            {% for col in columns %}
            <td>
              {% if col.type == "badge" %}
                <span class="badge badge-sm {{ item[col.key] | badge_class }}">{{ item[col.key] | default("") }}</span>
              {% elif col.type == "bool" %}
                {{ item[col.key] | bool_icon }}
              {% elif col.type == "date" %}
                {{ item[col.key] | dateformat }}
              {% elif col.type == "currency" %}
                {{ item[col.key] | currency }}
              {% elif col.type == "ref" %}
                {% set ref = item[col.key] %}
                {% if ref is mapping %}
                  {% set ref_display = ref.get("name") or ref.get("company_name") or ((ref.get("first_name", "") ~ " " ~ ref.get("last_name", "")) | trim) or ref.get("title") or ref.get("label") or ref.get("email") or ref.get("id", "") %}
                  {% if col.ref_route and ref.get("id") %}
                    <a href="{{ col.ref_route | replace('{id}', ref.id|string) }}" class="link link-hover link-primary" onclick="event.stopPropagation()">{{ ref_display }}</a>
                  {% else %}{{ ref_display }}{% endif %}
                {% elif ref %}{{ ref }}{% else %}-{% endif %}
              {% else %}
                {{ item[col.key] | default("") | truncate_text }}
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
</div>
