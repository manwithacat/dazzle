{# Detail view component - displays entity fields as a definition list #}
{% if detail %}
<div class="{% if detail.related_tabs %}max-w-5xl{% else %}max-w-3xl{% endif %}" data-dazzle-entity="{{ detail.entity_name }}">
  {# Header with actions #}
  {% block detail_header %}
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <a href="{{ detail.back_url }}" class="btn btn-ghost btn-sm">&larr; Back</a>
      <h2 class="text-2xl font-bold">{{ detail.title }}</h2>
    </div>
    <div class="flex gap-2">
      {% if detail.edit_url %}
      <a href="{{ detail.edit_url }}" class="btn btn-outline btn-sm" data-dazzle-action="{{ detail.entity_name }}.edit">Edit</a>
      {% endif %}
      {% if detail.delete_url %}
      <button class="btn btn-error btn-outline btn-sm"
              data-dazzle-action="{{ detail.entity_name }}.delete"
              hx-delete="{{ detail.delete_url }}"
              hx-confirm="Delete this {{ detail.entity_name | lower }}?"
              hx-target="body"
              hx-swap="innerHTML">
        Delete
      </button>
      {% endif %}
    </div>
  </div>
  {% endblock detail_header %}

  {# Transition buttons (state machine) #}
  {% block detail_transitions %}
  {% if detail.transitions %}
  <div class="flex gap-2 mb-4" data-dazzle-transitions="{{ detail.entity_name }}">
    {% for transition in detail.transitions %}
    <button class="btn btn-outline btn-sm"
            data-dazzle-action="{{ detail.entity_name }}.transition.{{ transition.to_state }}"
            hx-put="{{ transition.api_url }}"
            hx-vals='{"{{ detail.status_field }}": "{{ transition.to_state }}"}'
            hx-ext="json-enc"
            hx-target="body"
            hx-swap="innerHTML">
      {{ transition.label }}
    </button>
    {% endfor %}
  </div>
  {% endif %}
  {% endblock detail_transitions %}

  {# Detail card #}
  {% block detail_fields %}
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body">
      <dl class="divide-y divide-base-200">
        {% for field in detail.fields %}
        {% set value = detail.item.get(field.name, "") %}
        <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4">
          <dt class="text-sm font-medium text-base-content/70">{{ field.label }}</dt>
          <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
            {% if field.type == "badge" %}
              {% include 'fragments/status_badge.html' %}
            {% elif field.type == "bool" or field.type == "checkbox" %}
              {{ value | bool_icon }}
            {% elif field.type == "date" %}
              {{ value | dateformat }}
            {% elif field.type == "currency" or field.type == "money" %}
              {{ value | currency(field.extra.get('currency_code', 'GBP') if field.extra else 'GBP') }}
            {% elif field.type == "ref" %}
              {% if value is mapping %}{{ value.get("name") or value.get("title") or value.get("label") or value.get("email") or value.get("id", "—") }}{% elif value %}{{ value }}{% else %}—{% endif %}
            {% else %}
              {{ value | default("—") }}
            {% endif %}
          </dd>
        </div>
        {% endfor %}
      </dl>
    </div>
  </div>
  {% endblock detail_fields %}

  {# Related entity tabs (hub-and-spoke, #301) #}
  {% if detail.related_tabs %}
  {% block detail_related_tabs %}
  <div class="mt-6" data-dazzle-related="{{ detail.entity_name }}">
    {# Tab navigation with count badges #}
    <div class="tabs tabs-bordered" role="tablist">
      {% for tab in detail.related_tabs %}
      <button class="tab{% if loop.first %} tab-active{% endif %}"
              role="tab"
              aria-selected="{{ 'true' if loop.first else 'false' }}"
              data-dz-tab="{{ tab.tab_id }}"
              onclick="document.querySelectorAll('[data-dz-tab]').forEach(t=>{t.classList.remove('tab-active');t.setAttribute('aria-selected','false')});this.classList.add('tab-active');this.setAttribute('aria-selected','true');document.querySelectorAll('[data-dz-tab-panel]').forEach(p=>p.hidden=true);document.querySelector('[data-dz-tab-panel=&quot;'+this.dataset.dzTab+'&quot;]').hidden=false">
        {{ tab.label }}
        <span class="badge badge-sm ml-1">{{ tab.total }}</span>
      </button>
      {% endfor %}
    </div>

    {# Tab panels #}
    {% for tab in detail.related_tabs %}
    <div data-dz-tab-panel="{{ tab.tab_id }}" {% if not loop.first %}hidden{% endif %} role="tabpanel">
      <div class="card bg-base-100 shadow-sm mt-2">
        <div class="card-body p-0">
          {% if tab.create_url %}
          <div class="flex justify-end p-3 pb-0">
            <a href="{{ tab.create_url }}?{{ tab.filter_field }}={{ detail.item.get('id', '') }}"
               class="btn btn-primary btn-sm"
               data-dazzle-action="{{ tab.entity_name }}.create">
              + New {{ tab.label }}
            </a>
          </div>
          {% endif %}

          <div class="overflow-x-auto">
            <table class="table table-zebra w-full" data-entity="{{ tab.entity_name }}">
              <thead>
                <tr>
                  {% for col in tab.columns %}
                  <th scope="col">{{ col.label }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% if tab.rows %}
                {% for item in tab.rows %}
                <tr class="hover cursor-pointer"
                    {% if tab.detail_url_template %}
                    hx-get="{{ tab.detail_url_template.replace('{id}', item.id | string) }}"
                    hx-push-url="true"
                    hx-target="body"
                    hx-swap="innerHTML"
                    {% endif %}>
                  {% for col in tab.columns %}
                  <td>
                    {% if col.type == "badge" %}
                      <span class="badge {{ item[col.key] | badge_class }}">{{ item[col.key] | default("") }}</span>
                    {% elif col.type == "bool" %}
                      {{ item[col.key] | bool_icon }}
                    {% elif col.type == "date" %}
                      {{ item[col.key] | dateformat }}
                    {% elif col.type == "currency" %}
                      {{ item[col.key] | currency(col.currency_code or "GBP") }}
                    {% else %}
                      {{ item[col.key] | default("") | truncate_text }}
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                  <td colspan="{{ tab.columns | length }}" class="text-center py-8 text-base-content/50">
                    No {{ tab.label | lower }} found.
                  </td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endblock detail_related_tabs %}
  {% endif %}
</div>
{% endif %}
