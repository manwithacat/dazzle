# OpenAPI Backend Analysis and Improvement Proposal

**Date**: 2025-11-23
**Status**: Analysis Complete
**Context**: Review of `openapi_only` stack and backend-only architecture

---

## Current State

### `openapi` Backend (`src/dazzle/stacks/openapi.py`)

**What It Does**:
- ‚úÖ Generates OpenAPI 3.0 specification file (`openapi.yaml` or `openapi.json`)
- ‚úÖ Maps entities to schemas (components/schemas)
- ‚úÖ Maps surfaces to paths/operations:
  - `LIST` ‚Üí `GET /resources`
  - `VIEW` ‚Üí `GET /resources/{id}`
  - `CREATE` ‚Üí `POST /resources`
  - `EDIT` ‚Üí `PUT /resources/{id}`
- ‚úÖ Includes security scheme placeholder (bearerAuth with JWT)
- ‚úÖ Generates tags from entities
- ‚úÖ Includes request/response schemas with proper references

**What It Doesn't Do**:
- ‚ùå Does NOT deploy a backend server
- ‚ùå Does NOT include Swagger UI
- ‚ùå Does NOT generate API tokens
- ‚ùå Does NOT implement actual API endpoints
- ‚ùå Just generates a specification file (static artifact)

**Example Output** (`openapi.yaml`):
```yaml
openapi: 3.0.0
info:
  title: Simple Test App
  version: 0.1.0
paths:
  /tasks:
    get:
      summary: Task List
      operationId: listTask
      # ... (200 response with array of Task schemas)
    post:
      summary: Create Task
      operationId: createTask
      # ... (201 response, 400 error)
  /tasks/{id}:
    get:
      summary: Task Detail
      # ... (200 response, 404 error)
    put:
      summary: Edit Task
      # ... (200 response, 404/400 errors)
components:
  schemas:
    Task:
      type: object
      properties:
        id: { type: string, format: uuid }
        title: { type: string, maxLength: 200 }
        # ... other fields
      required: [title]
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
```

**Use Cases**:
- ‚úÖ Contract-first API design
- ‚úÖ API documentation generation
- ‚úÖ Client SDK generation (using swagger-codegen, openapi-generator)
- ‚úÖ API mocking (using Prism, Mockoon)
- ‚ùå NOT for actual backend deployment

---

### `django_api` Backend (`src/dazzle/stacks/django_api.py`)

**What It Does**:
- ‚úÖ Generates complete Django REST Framework project
- ‚úÖ Creates models (Django ORM)
- ‚úÖ Creates serializers (DRF)
- ‚úÖ Creates viewsets (DRF)
- ‚úÖ Configures URLs and routing
- ‚úÖ Includes requirements.txt with dependencies
- ‚úÖ Creates manage.py for Django management

**What It Doesn't Do** (yet):
- ‚ùå No built-in Swagger UI
- ‚ùå No API token generation
- ‚ùå No authentication setup
- ‚ùå No deployment configuration

**Surfaces Mapping**:
- `LIST` ‚Üí `ModelViewSet` with list action
- `VIEW` ‚Üí `ModelViewSet` with retrieve action
- `CREATE` ‚Üí `ModelViewSet` with create action
- `EDIT` ‚Üí `ModelViewSet` with update action

---

## Gap Analysis

### User Expectation vs. Current State

| Feature | User Expects | `openapi` | `django_api` | Gap |
|---------|-------------|-----------|--------------|-----|
| **Backend Server** | ‚úÖ Deployed server | ‚ùå No | ‚úÖ Yes | `openapi` needs server |
| **Swagger UI** | ‚úÖ Interactive docs | ‚ùå No | ‚ùå No | Both need Swagger UI |
| **API Token Gen** | ‚úÖ Auto-generated tokens | ‚ùå No | ‚ùå No | Both need token gen |
| **Token Storage** | ‚úÖ Non-tracked file | ‚ùå No | ‚ùå No | Both need `.api_credentials` |
| **Authentication** | ‚úÖ JWT/Token auth | ‚ö† Placeholder | ‚ùå No | Both need auth implementation |
| **Actual Endpoints** | ‚úÖ Working API | ‚ùå No | ‚úÖ Yes | `openapi` is spec-only |

---

## Proposed Solution

### Option 1: Enhance `django_api` Backend (Recommended)

**Make `django_api` a true "backend-only with Swagger UI" stack.**

**Additions Needed**:

1. **Swagger UI Integration**
   - Install `drf-spectacular` (DRF OpenAPI generator + Swagger UI)
   - Auto-configure Swagger UI at `/api/docs/`
   - Auto-generate OpenAPI spec from DRF viewsets

   ```python
   # settings.py
   INSTALLED_APPS = [
       # ...
       'rest_framework',
       'drf_spectacular',
   ]

   REST_FRAMEWORK = {
       'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
   }

   SPECTACULAR_SETTINGS = {
       'TITLE': 'Your API',
       'DESCRIPTION': 'API generated by DAZZLE',
       'VERSION': '1.0.0',
       'SERVE_INCLUDE_SCHEMA': False,
   }
   ```

   ```python
   # urls.py
   from drf_spectacular.views import SpectacularAPIView, SpectacularSwaggerView

   urlpatterns = [
       path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
       path('api/docs/', SpectacularSwaggerView.as_view(url_name='schema'), name='docs'),
       # ... existing patterns
   ]
   ```

2. **API Token Generation**
   - Use Django REST Framework's built-in Token Authentication
   - Generate initial token on build
   - Store in `.api_credentials` (gitignored)

   ```python
   # Post-build hook: generate_api_tokens.py
   from django.contrib.auth.models import User
   from rest_framework.authtoken.models import Token

   # Create admin user
   user = User.objects.create_superuser('admin', 'admin@example.com', '<generated-password>')

   # Generate token
   token = Token.objects.create(user=user)

   # Write to .api_credentials
   with open('.api_credentials', 'w') as f:
       f.write(f"API Token: {token.key}\n")
       f.write(f"Admin Username: admin\n")
       f.write(f"Admin Password: <generated-password>\n")
   ```

3. **Authentication Configuration**
   ```python
   # settings.py
   REST_FRAMEWORK = {
       'DEFAULT_AUTHENTICATION_CLASSES': [
           'rest_framework.authentication.TokenAuthentication',
           'rest_framework.authentication.SessionAuthentication',
       ],
       'DEFAULT_PERMISSION_CLASSES': [
           'rest_framework.permissions.IsAuthenticated',
       ],
   }
   ```

4. **CORS Configuration**
   - Already implemented (uses `django-cors-headers`)
   - Allows frontend apps to call API

5. **Deployment-Ready**
   - Include gunicorn in requirements
   - Add Procfile for Heroku/Railway
   - Add docker-compose.yml option

**Generated Structure**:
```
build/
‚îú‚îÄ‚îÄ api/                     # Django app
‚îÇ   ‚îú‚îÄ‚îÄ models.py           # Generated models
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py      # Generated serializers
‚îÇ   ‚îú‚îÄ‚îÄ views.py            # Generated viewsets
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ config/                  # Django project settings
‚îÇ   ‚îú‚îÄ‚îÄ settings.py         # With DRF, Spectacular, CORS
‚îÇ   ‚îú‚îÄ‚îÄ urls.py             # With Swagger UI routes
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ manage.py
‚îú‚îÄ‚îÄ requirements.txt        # Including drf-spectacular
‚îú‚îÄ‚îÄ .api_credentials        # GITIGNORED - contains tokens
‚îú‚îÄ‚îÄ .gitignore
‚îî‚îÄ‚îÄ README.md

# After running server
http://localhost:8000/api/docs/     # Swagger UI
http://localhost:8000/api/schema/   # OpenAPI spec
http://localhost:8000/api/tasks/    # Actual endpoints
```

---

### Option 2: Create New `fastapi` Backend

**Alternative: Use FastAPI instead of Django**

**Advantages**:
- ‚úÖ Built-in Swagger UI (at `/docs`)
- ‚úÖ Built-in OpenAPI spec (at `/openapi.json`)
- ‚úÖ Automatic request/response validation
- ‚úÖ Async support
- ‚úÖ Simpler, more modern
- ‚úÖ Smaller deployment footprint

**Implementation**:
```python
# FastAPI backend would generate:
from fastapi import FastAPI, Depends
from sqlalchemy import create_engine
from pydantic import BaseModel

app = FastAPI(title="Your API", version="1.0.0")

# Auto-generated models, routes, authentication
# Swagger UI automatically available at /docs
# OpenAPI spec automatically available at /openapi.json
```

**Challenges**:
- Need to implement ORM mapping (use SQLAlchemy)
- Need to implement auth (use FastAPI security utilities)
- More work than enhancing existing Django backend

---

## Surface Mapping in Backend-Only Architecture

### How Surfaces Map to API Endpoints

**Current Mapping** (already implemented in both backends):

| Surface Mode | HTTP Method | Path | Operation | Example |
|--------------|-------------|------|-----------|---------|
| `LIST` | GET | `/resources` | List all | `GET /tasks` ‚Üí 200 with array |
| `VIEW` | GET | `/resources/{id}` | Get one | `GET /tasks/123` ‚Üí 200 with object |
| `CREATE` | POST | `/resources` | Create new | `POST /tasks` ‚Üí 201 with created object |
| `EDIT` | PUT/PATCH | `/resources/{id}` | Update | `PUT /tasks/123` ‚Üí 200 with updated object |

**Surface Fields** ‚Üí Serializer fields:
- Fields in surface sections determine which fields are exposed in API
- Example: `task_create` surface with only `title` and `description` ‚Üí POST body accepts only those fields
- Example: `task_list` surface with `title`, `status`, `created_at` ‚Üí GET response includes only those fields

**Proposed Enhancement**: **Field-level control**:
```dsl
surface task_create "Create Task":
  uses entity Task
  mode: create

  section main "New Task":
    field title "Title" readonly=false      # Writable
    field description "Description"         # Writable
    # status NOT included ‚Üí defaults to 'todo' (from entity)
    # created_at NOT included ‚Üí auto-set
```

Generated serializer:
```python
class TaskCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Task
        fields = ['title', 'description']  # Only fields from surface
        # status, created_at handled by model defaults
```

---

## API Token Generation Proposal

### Requirements

1. **Generate on build** (post-build hook)
2. **Store in non-tracked file** (`.api_credentials`)
3. **Provide clear instructions** (in README and build output)

### Implementation Plan

**File**: `src/dazzle/stacks/django_api/hooks/generate_tokens.py`

```python
import secrets
from pathlib import Path
import subprocess

class GenerateAPITokensHook:
    """Generate API tokens after Django API build."""

    def execute(self, output_dir: Path):
        """
        Generate admin user and API token.

        Creates:
        - Admin user (username: admin)
        - API token
        - .api_credentials file (gitignored)
        """
        credentials_file = output_dir / '.api_credentials'

        # Generate secure password
        admin_password = secrets.token_urlsafe(16)

        # Run Django commands to create user and token
        commands = [
            # Create superuser
            f'python manage.py shell -c "from django.contrib.auth.models import User; User.objects.create_superuser(\'admin\', \'admin@localhost\', \'{admin_password}\')"',

            # Generate token
            'python manage.py shell -c "from django.contrib.auth.models import User; from rest_framework.authtoken.models import Token; user = User.objects.get(username=\'admin\'); token, created = Token.objects.get_or_create(user=user); print(token.key)"',
        ]

        # Execute and capture token
        token = subprocess.check_output(
            commands[1],
            shell=True,
            cwd=output_dir,
            text=True
        ).strip()

        # Write credentials
        credentials_file.write_text(f"""# API Credentials
# DO NOT COMMIT THIS FILE

Admin Username: admin
Admin Password: {admin_password}
API Token: {token}

# Usage:
# curl -H "Authorization: Token {token}" http://localhost:8000/api/tasks/

# Swagger UI: http://localhost:8000/api/docs/
""")

        # Ensure .gitignore includes this file
        gitignore = output_dir / '.gitignore'
        if gitignore.exists():
            content = gitignore.read_text()
            if '.api_credentials' not in content:
                gitignore.write_text(content + '\n.api_credentials\n')
        else:
            gitignore.write_text('.api_credentials\n')

        return f"‚úì API credentials generated: {credentials_file}"
```

**Registration** in `django_api` backend:
```python
def generate(self, appspec, output_dir, **options):
    # ... existing generation
    self._generate_settings(appspec, output_dir)
    self._generate_requirements(appspec, output_dir)

    # NEW: Add post-build hooks
    hooks = [
        SetupVirtualEnvHook(),
        RunMigrationsHook(),
        GenerateAPITokensHook(),  # NEW
    ]

    for hook in hooks:
        result = hook.execute(output_dir)
        print(f"  {result}")
```

---

## Recommended Implementation Path

### Phase 1: Enhance `django_api` Backend (High Priority)

**Tasks**:
1. ‚úÖ Add `drf-spectacular` to requirements
2. ‚úÖ Configure Swagger UI in settings and URLs
3. ‚úÖ Add API token generation hook
4. ‚úÖ Add `.api_credentials` to .gitignore
5. ‚úÖ Update README with API access instructions
6. ‚úÖ Test with simple_task example

**Expected Result**:
```bash
$ dazzle build --stack django_api
# ... build output
‚úì Swagger UI configured: http://localhost:8000/api/docs/
‚úì API credentials generated: .api_credentials

$ cd build/<project>
$ cat .api_credentials
Admin Username: admin
Admin Password: xk8J...
API Token: 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b

$ python manage.py runserver
# Visit http://localhost:8000/api/docs/ for interactive API docs
# Use token: curl -H "Authorization: Token 9944b09..." http://localhost:8000/api/tasks/
```

### Phase 2: Update `openapi_only` Stack (Medium Priority)

**Current behavior**: Just generates OpenAPI YAML spec

**Proposed enhancement**: Add mock server option
```bash
$ dazzle build --stack openapi_only
# Generates openapi.yaml

# NEW: Optional mock server
$ cd build/openapi
$ npm install -g @stoplight/prism-cli
$ prism mock openapi.yaml
# Mock API running at http://localhost:4010
```

**OR**: Include mock server in build:
```bash
$ dazzle build --stack openapi_only --with-mock-server
# Generates:
#   - openapi.yaml
#   - docker-compose.yml with Prism mock server
#   - README with instructions
```

### Phase 3: Create `fastapi` Backend (Low Priority)

**Long-term alternative** for users who prefer FastAPI over Django.

---

## Comparison of Proposed Solutions

| Feature | Enhanced `django_api` | `openapi` + Mock Server | New `fastapi` Backend |
|---------|----------------------|-------------------------|----------------------|
| **Real Backend** | ‚úÖ Yes | ‚ö† Mock only | ‚úÖ Yes |
| **Swagger UI** | ‚úÖ drf-spectacular | ‚úÖ Prism UI | ‚úÖ Built-in |
| **API Tokens** | ‚úÖ DRF tokens | ‚ùå N/A (mock) | ‚úÖ JWT/OAuth2 |
| **Database** | ‚úÖ Django ORM | ‚ùå No database | ‚úÖ SQLAlchemy |
| **Effort** | üü¢ Low (enhance existing) | üü¢ Low (add wrapper) | üü° Medium (new backend) |
| **Maturity** | ‚úÖ Stable (Django/DRF) | ‚ö† Mock only | ‚úÖ Stable (FastAPI) |
| **Deployment** | ‚úÖ Production-ready | ‚ùå Dev only | ‚úÖ Production-ready |

**Recommendation**: **Start with Phase 1** (enhance `django_api`) - provides the most value with least effort.

---

## Questions Answered

### 1. What is the current state of the `openapi` backend?

**Answer**: The `openapi` backend generates OpenAPI 3.0 specification files (YAML or JSON) that describe the API structure. It does NOT deploy a backend or provide Swagger UI - it's purely a specification generator for contract-first API design.

### 2. How do surfaces map to backend-only structure?

**Answer**:
- `LIST` surface ‚Üí `GET /resources` endpoint (returns array)
- `VIEW` surface ‚Üí `GET /resources/{id}` endpoint (returns single object)
- `CREATE` surface ‚Üí `POST /resources` endpoint (accepts body, returns created)
- `EDIT` surface ‚Üí `PUT /resources/{id}` endpoint (accepts body, returns updated)

Surface fields determine which entity fields are exposed in serializers/schemas.

### 3. Should we have backend-only with Swagger UI?

**Answer**: **Yes**, absolutely. This is a common need for:
- API-first development
- Microservices architecture
- Headless applications
- Mobile app backends

**Recommendation**: Enhance `django_api` to include Swagger UI, token generation, and clear deployment instructions.

---

## Next Steps

1. **Decide**: Which approach? (Recommend Phase 1 - enhance `django_api`)
2. **Implement**: Add Swagger UI and token generation to `django_api`
3. **Test**: Build simple_task with enhanced `django_api`
4. **Document**: Update stack capabilities and usage examples
5. **Release**: Include in next DAZZLE version (v0.1.2?)

---

## Files to Modify

**If implementing Phase 1**:

1. `src/dazzle/stacks/django_api.py` - Add Swagger UI configuration
2. `src/dazzle/stacks/django_api/hooks/` (new) - Add token generation hook
3. `src/dazzle/stacks/django_api/templates/` - Update settings, URLs templates
4. `docs/STACK_CAPABILITIES.md` (new) - Document all stack features

---

## Conclusion

The current `openapi_only` stack generates specifications only. For a true "backend-only with Swagger UI" experience, we should:

1. **Short-term**: Enhance `django_api` backend with Swagger UI and token generation
2. **Medium-term**: Optionally add mock server capability to `openapi`
3. **Long-term**: Consider FastAPI backend as an alternative

This provides users with a complete, production-ready API backend that matches their expectations.
