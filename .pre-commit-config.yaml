# Pre-commit hooks for DAZZLE
# See https://pre-commit.com for more information

default_language_version:
  python: python3

repos:
  # General file cleanup
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-toml
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: detect-private-key
      - id: mixed-line-ending
        args: ['--fix=lf']

  # Ruff - Fast Python linter and formatter
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.2
    hooks:
      # Run the linter
      - id: ruff
        args: ['--fix']
      # Run the formatter
      - id: ruff-format

  # Type checking with mypy
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.13.0
    hooks:
      - id: mypy
        additional_dependencies:
          - pydantic>=2.0
          - typer>=0.9
          - types-PyYAML
        args: ['--config-file=pyproject.toml']
        files: ^src/

  # Security checks
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit
        args: ['-c', 'pyproject.toml']
        additional_dependencies: ['bandit[toml]']
        exclude: ^tests/

  # JavaScript/ESLint
  - repo: local
    hooks:
      - id: eslint
        name: eslint
        entry: npx eslint
        language: system
        files: ^src/dazzle_dnr_ui/runtime/static/js/.*\.js$
        exclude: \.test\.js$
        pass_filenames: true

      - id: js-typecheck
        name: js-typecheck
        entry: npm run typecheck
        language: system
        files: ^src/dazzle_dnr_ui/runtime/static/js/.*\.js$
        pass_filenames: false

      - id: js-tests
        name: js-tests
        entry: npx vitest run
        language: system
        files: ^src/dazzle_dnr_ui/runtime/static/js/.*\.js$
        pass_filenames: false

  # DSL validation
  - repo: local
    hooks:
      - id: dsl-validate
        name: dsl-validate
        entry: bash -c 'exit_code=0; for f in "$@"; do dir=$(dirname "$f"); while [ "$dir" != "." ] && [ ! -f "$dir/dsl/app.dsl" ]; do dir=$(dirname "$dir"); done; if [ -f "$dir/dsl/app.dsl" ]; then (cd "$dir" && python -m dazzle validate) || exit_code=1; fi; done; exit $exit_code' --
        language: system
        files: \.dsl$
        exclude: (templates/|_archive/)
        pass_filenames: true

      # Run fast unit tests on Python changes
      - id: pytest-fast
        name: pytest-fast
        entry: pytest tests/unit -x -q --tb=short -m "not slow"
        language: system
        files: ^src/dazzle/.*\.py$
        pass_filenames: false
        stages: [pre-commit]

      # Parser corpus snapshot tests (catches parser regressions)
      - id: parser-corpus
        name: parser-corpus
        entry: pytest tests/parser_corpus/ -x -q --tb=short
        language: system
        files: ^(src/dazzle/core/dsl_parser.*\.py|tests/parser_corpus/|tests/corpora/)
        pass_filenames: false
        stages: [pre-commit]

      # Verify MCP server functionality (tools are published correctly)
      - id: mcp-verify
        name: mcp-verify
        entry: python scripts/verify-mcp.py
        language: system
        files: ^src/dazzle/mcp/.*\.py$
        pass_filenames: false
        stages: [pre-commit]

      # Validate Homebrew formula syntax
      - id: homebrew-validate
        name: homebrew-validate
        entry: ruby -c
        language: system
        files: ^homebrew/.*\.rb$
        pass_filenames: true
        stages: [pre-commit]

      # Verify PyPI wheel URLs are valid (checks that URLs exist)
      - id: verify-pypi-urls
        name: verify-pypi-urls
        entry: bash -c 'grep -oE "https://files.pythonhosted.org/[^\"]+\.whl" "$@" | while read url; do echo "Checking $url..."; curl -sIf "$url" > /dev/null || { echo "ERROR: Invalid URL: $url"; exit 1; }; done'
        language: system
        files: ^(homebrew/.*\.rb|\.github/workflows/release-cli\.yml)$
        pass_filenames: true
        stages: [pre-push]

# Configuration for specific hooks can be added to pyproject.toml
